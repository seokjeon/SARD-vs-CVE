# ğŸ“ CVE-2017-15108

## ğŸ” ì·¨ì•½ì  ê°œìš”

**ğŸ”— [ì»¤ë°‹ ë§í¬](https://cgit.freedesktop.org/spice/linux/vd_agent/commit/?id=8ba174816d245757e743e636df357910e1d5eb61)** | **ğŸ”— [CVE ë§í¬](https://www.cvedetails.com/cve/CVE-2017-15108/)** | **ğŸ”— [CWE ë§í¬](https://cwe.mitre.org/data/definitions/78.html)**

> spice-vdagent 0.17.0 ì´í•˜ ë²„ì „ì—ì„œ save directoryë¥¼ ì‰˜ì— ì „ë‹¬í•˜ê¸° ì „ì— ì ì ˆíˆ ì´ìŠ¤ì¼€ì´í”„í•˜ì§€ ì•Šì•„, ì„¸ì…˜ì— ì ‘ê·¼ ê¶Œí•œì´ ìˆëŠ” ë¡œì»¬ ê³µê²©ìê°€ ì„ì˜ì˜ ëª…ë ¹ì–´ë¥¼ ì£¼ì…í•˜ì—¬ ì‹¤í–‰í•  ìˆ˜ ìˆëŠ” OS Command Injection ì·¨ì•½ì ì…ë‹ˆë‹¤.

â€» SPICE(Simple Protocol for Independent Computing Environments) í™˜ê²½ì—ì„œ ì‚¬ìš©í•˜ëŠ” ê²ŒìŠ¤íŠ¸ ì—ì´ì „íŠ¸ í”„ë¡œê·¸ë¨ì…ë‹ˆë‹¤. ì£¼ë¡œ ê°€ìƒ ë¨¸ì‹ (VM) ë‚´ë¶€ì— ì„¤ì¹˜ë˜ë©°, SPICE í”„ë¡œí† ì½œì„ ì‚¬ìš©í•˜ëŠ” ê°€ìƒí™” ì†”ë£¨ì…˜(ì˜ˆ: QEMU/KVM)ì˜ ê²ŒìŠ¤íŠ¸ì™€ í˜¸ìŠ¤íŠ¸ ê°„ í†µì‹ ì„ í–¥ìƒì‹œí‚¤ëŠ” ì—­í• ì„ í•©ë‹ˆë‹¤.

* **ì·¨ì•½ ì¡°ê±´**: `xfers->save_dir`ì„ ì‰˜ì— ì „ë‹¬í•˜ê¸° ì „ì— ì´ìŠ¤ì¼€ì´í”„í•˜ì§€ ì•ŠìŒ
* **Sink**: ì…ë ¥ê°’ì„ ê²€ì¦í•˜ì§€ ì•Šê³  `system()` í•¨ìˆ˜ì— ì§ì ‘ ì‚¬ìš©

---

## íƒì§€ ê²°ê³¼ ìš”ì•½
CVE ì„¤ëª…ì— ë‚˜ì˜¨ ì·¨ì•½í•œ í•¨ìˆ˜(vdagent_file_xfers_data())ì— ëŒ€í•œ ìŠ¬ë¼ì´ìŠ¤ë§Œ ê³ ë ¤í–ˆì„ ë•Œ,

| ì´ ìŠ¬ë¼ì´ìŠ¤ ìˆ˜ |  ì·¨ì•½ìœ¼ë¡œ íƒì§€ | ì •ìƒìœ¼ë¡œ íƒì§€ |
| --------  | -- | -- |
| 15ê°œ       | 0ê°œ | 15ê°œ |

vdagent_file_xfers_data()ì—ì„œ ì¶”ì¶œí•œ ìŠ¬ë¼ì´ìŠ¤ ì¤‘, Sink(`system()` í•¨ìˆ˜) ê´€ë ¨ ìŠ¬ë¼ì´ìŠ¤ëŠ” 1ê±´ ìˆì—ˆìœ¼ë‚˜, **ì •ìƒìœ¼ë¡œ íƒì§€ë¨**

|FileName           |Caller                 |Source|Sink |idx|CWE-ID|category      |criterion|line|label|token_length|predict|
|-------------------|-----------------------|------|-----|---|------|--------------|---------|----|-----|------------|-------|
|before_file-xfers.c|vdagent_file_xfers_data|FALSE |FALSE|51 |CWE-  |CallExpression|system   |341 |-3   |161         |0      |

ì´ CVE ì·¨ì•½ì ì„ ìœ ë°œí•˜ëŠ” ì½”ë“œ(sink:src/vdagent/file-xfers.c:341)ëŠ” ì•„ë˜ì™€ ê°™ë‹¤.
```
void vdagent_file_xfers_data(struct vdagent_file_xfers *xfers,
    VDAgentFileXferDataMessage *msg)
{
    AgentFileXferTask *task;
    int len, status = -1;

    g_return_if_fail(xfers != NULL);

    task = vdagent_file_xfers_get_task(xfers, msg->id);
    if (!task)
        return;

    len = write(task->file_fd, msg->data, msg->size);
    if (len == msg->size) {
        task->read_bytes += msg->size;
        if (task->read_bytes >= task->file_size) {
            if (task->read_bytes == task->file_size) {
                if (xfers->debug)
                    syslog(LOG_DEBUG, "file-xfer: task %u %s has completed",
                           task->id, task->file_name);
                close(task->file_fd);
                task->file_fd = -1;
                if (xfers->open_save_dir &&
                        task->file_xfer_nr == task->file_xfer_total &&
                        g_hash_table_size(xfers->xfers) == 1) {
                    char buf[PATH_MAX];
                    snprintf(buf, PATH_MAX, "xdg-open '%s'&", xfers->save_dir);
                    status = system(buf);
```

ì´ ì½”ë“œì—ì„œ Ksign ìŠ¬ë¼ì´ì„œ ë„êµ¬ê°€ ì¶”ì¶œí–ˆì–´ì•¼ í•˜ëŠ” ìŠ¬ë¼ì´ìŠ¤ë¥¼ ì§ì ‘ ì‘ì„±í•´ë³´ë©´ ë‹¤ìŒê³¼ ê°™ë‹¤.

```c
/* src/vdagent/vdagent.c:354 */
static gboolean vdagent_init_async_cb(gpointer user_data)
{
    VDAgent *agent = user_data;
    GError *err = NULL;

    agent->conn = udscs_connect(
        vdagentd_socket,
        daemon_read_complete,
        daemon_error_cb,
        debug,
        &err
    );
}

/* src/vdagent/vdagent.c:222 */
static void daemon_read_complete(UdscsConnection *conn,
    struct udscs_message_header *header, uint8_t *data)
{
    VDAgent *agent = g_object_get_data(G_OBJECT(conn), "agent");

    switch (header->type) {
        case VDAGENTD_FILE_XFER_DATA:
            if (agent->xfers != NULL) {
                vdagent_file_xfers_data(
                    agent->xfers,
                    (VDAgentFileXferDataMessage *)data
                );
            }
            break;
        default:
            break;
    }
}
/* src/vdagent/file-xfers.c:341 */
void vdagent_file_xfers_data(struct vdagent_file_xfers *xfers,
    VDAgentFileXferDataMessage *msg)
{
    AgentFileXferTask *task;
    int len, status = -1;

    task = vdagent_file_xfers_get_task(xfers, msg->id);
    len = write(task->file_fd, msg->data, msg->size);

    if (len == msg->size) {
        task->read_bytes += msg->size;

        if (task->read_bytes >= task->file_size) {
            if (task->read_bytes == task->file_size) {
                if (xfers->debug) {
                    syslog(
                        LOG_DEBUG,
                        "file-xfer: task %u %s has completed",
                        task->id,
                        task->file_name
                    );
                }

                close(task->file_fd);
                task->file_fd = -1;

                if (xfers->open_save_dir &&
                    task->file_xfer_nr == task->file_xfer_total &&
                    g_hash_table_size(xfers->xfers) == 1) {
                    char buf[PATH_MAX];
                    snprintf(buf, PATH_MAX, "xdg-open '%s'&", xfers->save_dir);
                    status = system(buf);
                }
            }
        }
    }
}
```

ì´ ìŠ¬ë¼ì´ìŠ¤ë¥¼ ìˆ˜ë™ìœ¼ë¡œ Ksign ëª¨ë¸ì— ì ìš©í•´ì„œ ê²°ê³¼ë¥¼ íƒì§€í•´ë³´ì•˜ë”ë‹ˆ ì •ìƒìœ¼ë¡œ ì˜ˆì¸¡í–ˆë‹¤.


vdagent_init_async_cb() ì—ì„œ udscs_connect()ë¥¼ í˜¸ì¶œì—ì„œ ì½œë°± í•¨ìˆ˜ daemon_read_complete()ë¥¼ ë“±ë¡í•˜ì—¬ ë„¤íŠ¸ì›Œí¬ ì—°ê²°ì´ ì´ë£¨ì–´ì§ˆë•Œ, ì´ ì½œë°± í•¨ìˆ˜ë¥¼ í˜¸ì¶œí•˜ë„ë¡ í•œë‹¤.
daemon_read_complete() í•¨ìˆ˜ê°€ í˜¸ì¶œì´ ë˜ë©´, `VDAgent *agent = g_object_get_data(G_OBJECT(conn), "agent");` xfers->saved_dirì´ ë³´ë‚¸ ë©”ì‹œì§€ì— ì˜í•´ì„œ ì„¤ì •ì´ ëœë‹¤.
ì„¤ì •ëœ xfers->saved_dirì— ì €ì¥ëœ ê°’ìœ¼ë¡œ ì¸í•´ `snprintf(buf, PATH_MAX, "xdg-open '%s'&", xfers->save_dir);` ì½”ë“œë¡œ ì¸í•´ bufë‚´ìš©ì„ ì¡°ì‘í•  ìˆ˜ ìˆë‹¤.
ì¡°ì‘ëœ bufë¡œ `status = system(buf);` system() í˜¸ì¶œí•œë‹¤.

joernì—ì„œ ë¹Œë“œí•˜ëŠ” pdg(program dependence graph, cdg + ddg)ì— callbackì„ ë“±ë¡í•´ì„œ í˜¸ì¶œí•˜ëŠ” í”Œë¡œìš°ëŠ” í‘œí˜„í•  ìˆ˜ ì—†ë‹¤.
ê·¸ê²°ê³¼ ìŠ¬ë¼ì´ì„œë¥¼ ì¶”ì¶œí•˜ëŠ”ë° ì–´ë ¤ì›€ì´ ìˆì„ ìˆ˜ ìˆë‹¤.

#### SARDëŠ” ì˜ íƒì§€í•˜ëŠ”ë° ì´ CVEëŠ” íƒì§€ ëª»í–ˆë˜ ì´ìœ 

1. **ë¶€ì ì ˆí•œ criterion**
    - CWE78ì˜ SARD/README.mdì— ë”°ë¥´ë©´ 
        > ```bash
        > sojeon@swlab-u2404:~/Documents/research/SARD-vs-CVE/CWE78_OS_CI/SARD$ xsv search -s predict 1 test_output.csv | xsv select criterion | uniq
        >    criterion
        >    system
        > ```
    - ì´ ì·¨ì•½ì ì˜ ê²½ìš° criterionìœ¼ë¡œ `system`ì´ ì¡í˜”ì§€ë§Œ ëª¨ë¸ì´ í•™ìŠµí•œ íŒ¨í„´ê³¼ ë‹¬ë¼ ì •ìƒìœ¼ë¡œ íŒë‹¨ëœ ê²ƒìœ¼ë¡œ ë³´ì„.

---

## ì·¨ì•½ì  ì„¸ë¶€ ì‚¬í•­

### ğŸ“ ê´€ë ¨ íŒŒì¼ ì†Œê°œ
| íŒŒì¼ëª…            | ì„¤ëª…              |
| -------------- | --------------- |
| `before_file-xfers.c` | ì·¨ì•½ ì½”ë“œ (ìˆ˜ì • ì „) í¬í•¨ |
| `after_file-xfers.c`  | ê°œì„  ì½”ë“œ (ìˆ˜ì • í›„) í¬í•¨ |

---

### â—ï¸ ì·¨ì•½ ì½”ë“œ

**ë¬¸ì œì **:
1. `vdagent_file_xfers_data()`ì—ì„œ `xfers->save_dir`ì„ ì‰˜ì— ì „ë‹¬í•˜ê¸° ì „ì— ì´ìŠ¤ì¼€ì´í”„í•˜ì§€ ì•ŠìŒ
2. `snprintf()` ë°˜í™˜ê°’ì„ ê²€ì¦í•˜ì§€ ì•Šì•„, `xfers->save_dir`ì´ ë„ˆë¬´ ê¸¸ë©´ `&`, `'` ë“±ì˜ ë¬¸ìê°€ ëˆ„ë½ë  ìˆ˜ ìˆìŒ

#### Sink: `before_file-xfers.c:340-341`
```c
char buf[PATH_MAX];
snprintf(buf, PATH_MAX, "xdg-open '%s'&", xfers->save_dir);
status = system(buf); /* POTENTIAL FLAW */
```

---

### âœ… ê°œì„  ì½”ë“œ

**íŒ¨ì¹˜ ìœ„ì¹˜**: `after_file-xfers.c:340-348`

```c
GError *error = NULL;
gchar *argv[] = { "xdg-open", xfers->save_dir, NULL };
if (!g_spawn_async(NULL, argv, NULL,
                       G_SPAWN_SEARCH_PATH,
                       NULL, NULL, NULL, &error)) {
    syslog(LOG_WARNING,
           "file-xfer: failed to open save directory: %s",
           error->message);
    g_error_free(error);
}
```

**ê°œì„  ë°©ë²•**:

ì´ íŒ¨ì¹˜ëŠ” ê·¼ë³¸ì ì¸ ì•„í‚¤í…ì²˜ ë³€ê²½ì„ í†µí•´ ëª…ë ¹ì–´ ì¸ì ì…˜ì„ ì™„ì „íˆ ì°¨ë‹¨í•©ë‹ˆë‹¤:

* `system()` í•¨ìˆ˜ ëŒ€ì‹  `g_spawn_async()` ì‚¬ìš©ìœ¼ë¡œ ì‰˜ì„ ê±°ì¹˜ì§€ ì•Šê³  ì§ì ‘ í”„ë¡œì„¸ìŠ¤ ì‹¤í–‰
* `argv[]` ë°°ì—´ì„ í†µí•´ ëª…ë ¹ì–´ì™€ ì¸ìë¥¼ ëª…í™•íˆ ë¶„ë¦¬í•˜ì—¬ ì¸ì ì…˜ ë¶ˆê°€ëŠ¥
* `snprintf()` ì‚¬ìš©í•˜ì§€ ì•Šì•„ ë²„í¼ ì˜¤ë²„í”Œë¡œìš° ìœ„í—˜ ì œê±°
* ì‹¤í–‰ ì‹¤íŒ¨ ì‹œ ì ì ˆí•œ ì—ëŸ¬ ì²˜ë¦¬ ë° ë¡œê¹… ì¶”ê°€

---

## íƒì§€ ê²°ê³¼

|FileName           |Caller                 |Source|Sink |idx|CWE-ID|category      |criterion|line|label|token_length|predict|
|-------------------|-----------------------|------|-----|---|------|--------------|---------|----|-----|------------|-------|
|after_file-xfers.c |vdagent_file_xfers_data|FALSE |FALSE|20 |CWE-  |CallExpression|write    |326 |-3   |385         |0      |
|after_file-xfers.c |vdagent_file_xfers_data|FALSE |FALSE|21 |CWE-  |CallExpression|syslog   |332 |-3   |311         |0      |
|after_file-xfers.c |vdagent_file_xfers_data|FALSE |FALSE|22 |CWE-  |CallExpression|close    |334 |-3   |311         |0      |
|after_file-xfers.c |vdagent_file_xfers_data|FALSE |FALSE|23 |CWE-  |CallExpression|syslog   |344 |-3   |219         |0      |
|after_file-xfers.c |vdagent_file_xfers_data|FALSE |FALSE|24 |CWE-  |CallExpression|syslog   |352 |-3   |92          |0      |
|after_file-xfers.c |vdagent_file_xfers_data|FALSE |FALSE|25 |CWE-  |CallExpression|syslog   |357 |-3   |311         |0      |
|after_file-xfers.c |vdagent_file_xfers_data|FALSE |FALSE|26 |CWE-  |CallExpression|strerror |357 |-3   |311         |0      |
|before_file-xfers.c|vdagent_file_xfers_data|FALSE |FALSE|47 |CWE-  |CallExpression|write    |326 |-3   |309         |0      |
|before_file-xfers.c|vdagent_file_xfers_data|FALSE |FALSE|48 |CWE-  |CallExpression|syslog   |332 |-3   |246         |0      |
|before_file-xfers.c|vdagent_file_xfers_data|FALSE |FALSE|49 |CWE-  |CallExpression|close    |334 |-3   |246         |0      |
|before_file-xfers.c|vdagent_file_xfers_data|FALSE |FALSE|50 |CWE-  |CallExpression|snprintf |340 |-3   |277         |0      |
|before_file-xfers.c|vdagent_file_xfers_data|FALSE |FALSE|51 |CWE-  |CallExpression|system   |341 |-3   |161         |0      |
|before_file-xfers.c|vdagent_file_xfers_data|FALSE |FALSE|52 |CWE-  |CallExpression|syslog   |345 |-3   |92          |0      |
|before_file-xfers.c|vdagent_file_xfers_data|FALSE |FALSE|53 |CWE-  |CallExpression|syslog   |350 |-3   |246         |0      |
|before_file-xfers.c|vdagent_file_xfers_data|FALSE |FALSE|54 |CWE-  |CallExpression|strerror |350 |-3   |246         |0      |
