# ğŸ“ CVE-2017-15108

## ğŸ” ì·¨ì•½ì  ê°œìš”
**ğŸ”— [ì»¤ë°‹ ë§í¬](https://cgit.freedesktop.org/spice/linux/vd_agent/commit/?id=8ba174816d245757e743e636df357910e1d5eb61)** | **ğŸ”— [CVE ë§í¬](https://nvd.nist.gov/vuln/detail/CVE-2017-15108)** | **ğŸ”— [CWE ë§í¬](https://cwe.mitre.org/data/definitions/78.html)**

> spice-vdagentì˜ save directory ê³¼ì • ì¤‘ vdagent_file_xfers_data()ì—ì„œ ë°œìƒí•œ OS Command Injection ì·¨ì•½ì ì…ë‹ˆë‹¤.

â€» SPICE( Simple Protocol for Independent Computing Environments) í™˜ê²½ì—ì„œ ì‚¬ìš©í•˜ëŠ” ê²ŒìŠ¤íŠ¸ ì—ì´ì „íŠ¸ í”„ë¡œê·¸ë¨ì…ë‹ˆë‹¤. ì£¼ë¡œ ê°€ìƒ ë¨¸ì‹ (VM) ë‚´ë¶€ì— ì„¤ì¹˜ë˜ë©°, SPICE í”„ë¡œí† ì½œì„ ì‚¬ìš©í•˜ëŠ” ê°€ìƒí™” ì†”ë£¨ì…˜(ì˜ˆ: QEMU/KVM)ì˜ ê²ŒìŠ¤íŠ¸ì™€ í˜¸ìŠ¤íŠ¸ ê°„ í†µì‹ ì„ í–¥ìƒì‹œí‚¤ëŠ” ì—­í• ì„ í•©ë‹ˆë‹¤.

* **ì·¨ì•½ ì¡°ê±´**: ì…ë ¥ê°’ì„ ê²€ì¦í•˜ì§€ ì•Šê³ 
* **Sink**: ìœ„í—˜í•œ `system()` í•¨ìˆ˜ ì‚¬ìš©

## íƒì§€ ê²°ê³¼ ìš”ì•½
cve ì„¤ëª…ì— ë‚˜ì˜¨ ì·¨ì•½í•œ í•¨ìˆ˜(Caller, vdagent_file_xfers_data())ì— ëŒ€í•œ ìŠ¬ë¼ì´ìŠ¤ë§Œ ê³ ë ¤í–ˆì„ ë•Œ,

| ì´ ìŠ¬ë¼ì´ìŠ¤ ìˆ˜* |  ì •íƒ | ë¯¸íƒ |
| --------  | -- | -- |
| 15ê°œ       | 0ê°œ | 15ê°œ |

vdagent_file_xfers_data()ì—ì„œ ì¶”ì¶œí•œ ìŠ¬ë¼ì´ìŠ¤ ì¤‘, Sink(`system()` í•¨ìˆ˜) ê´€ë ¨ ìŠ¬ë¼ì´ìŠ¤ëŠ” 1ê±´ ìˆì—ˆìœ¼ë‚˜, **ì •ìƒìœ¼ë¡œ íƒì§€ë¨**

|FileName           |Caller                 |Source|Sink |idx|CWE-ID|category      |criterion|line|label|token_length|predict|
|-------------------|-----------------------|------|-----|---|------|--------------|---------|----|-----|------------|-------|
|before_file-xfers.c|vdagent_file_xfers_data|FALSE |FALSE|51 |CWE-  |CallExpression|system   |341 |-3   |161         |0      |

#### SARDëŠ” ì˜ íƒì§€í•˜ëŠ”ë° ì´ CVEëŠ” íƒì§€ ëª»í–ˆë˜ ì´ìœ 

1. **ë¶€ì ì ˆí•œ criterion**
    - CWE78ì˜ SARD/README.mdì— ë”°ë¥´ë©´ 
        > ```bash
        > sojeon@swlab-u2404:~/Documents/research/SARD-vs-CVE/CWE78_OS_CI/SARD$ xsv search -s predict 1 test_output.csv | xsv select criterion | uniq
        >    criterion
        >    strcat
        > ```
    - ì´ ì·¨ì•½ì ì˜ ê²½ìš° criterionìœ¼ë¡œ strcat()ì´ ì¡íˆì§€ ì•Šì•„ ì •ìƒìœ¼ë¡œ íŒë‹¨ëœ ê²ƒìœ¼ë¡œ ë³´ì„.

---

## ì·¨ì•½ì  ì„¸ë¶€ ì‚¬í•­
### â—ï¸ ì·¨ì•½ ì½”ë“œ

**ë¬¸ì œì **:
ì‚¬ìš©ì ì…ë ¥ì´ ì ì ˆíˆ ê²€ì¦ë˜ì§€ ì•Šì€ ì±„ë¡œ `system()` í•¨ìˆ˜ì˜ ì¸ìë¡œ ì‚¬ìš©ë˜ì–´ **ëª…ë ¹ì–´ ì¸ì ì…˜**ì´ ë°œìƒí•  ìˆ˜ ìˆìŒ.

#### Sink: `before_file-xfers.c:341`
```c
char buf[PATH_MAX];
snprintf(buf, PATH_MAX, "xdg-open '%s'&", xfers->save_dir);
status = system(buf); /* POTENTIAL FLAW */ 
```


### âœ… ê°œì„  ì½”ë“œ

**íŒ¨ì¹˜ ìœ„ì¹˜**: `after_file-xfers.c:340`

```c
GError *error = NULL;
gchar *argv[] = { "xdg-open", xfers->save_dir, NULL };
if (!g_spawn_async(NULL, argv, NULL,
                        G_SPAWN_SEARCH_PATH,
                        NULL, NULL, NULL, &error)) {
    syslog(LOG_WARNING,
            "file-xfer: failed to open save directory: %s",
            error->message);
    g_error_free(error);
}
```

**ê°œì„  ë°©ë²•**:

* argv[] ë°°ì—´ì„ í†µí•´ ëª…ë ¹ê³¼ ì¸ìë¥¼ êµ¬ë¶„í•´ì„œ ì²˜ë¦¬í•¨ â†’ ì‰˜ í•´ì„ ìš°íšŒ ë¶ˆê°€ëŠ¥
* ë˜í•œ, `system()` í•¨ìˆ˜ ëŒ€ì‹  ì•ˆì „í•œ g_spawn_async()ë¡œ ëŒ€ì²´

## íƒì§€ ê²°ê³¼
|FileName           |Caller                 |Source|Sink |idx|CWE-ID|category      |criterion|line|label|token_length|predict|
|-------------------|-----------------------|------|-----|---|------|--------------|---------|----|-----|------------|-------|
|after_file-xfers.c |vdagent_file_xfers_data|FALSE |FALSE|20 |CWE-  |CallExpression|write    |326 |-3   |385         |0      |
|after_file-xfers.c |vdagent_file_xfers_data|FALSE |FALSE|21 |CWE-  |CallExpression|syslog   |332 |-3   |311         |0      |
|after_file-xfers.c |vdagent_file_xfers_data|FALSE |FALSE|22 |CWE-  |CallExpression|close    |334 |-3   |311         |0      |
|after_file-xfers.c |vdagent_file_xfers_data|FALSE |FALSE|23 |CWE-  |CallExpression|syslog   |344 |-3   |219         |0      |
|after_file-xfers.c |vdagent_file_xfers_data|FALSE |FALSE|24 |CWE-  |CallExpression|syslog   |352 |-3   |92          |0      |
|after_file-xfers.c |vdagent_file_xfers_data|FALSE |FALSE|25 |CWE-  |CallExpression|syslog   |357 |-3   |311         |0      |
|after_file-xfers.c |vdagent_file_xfers_data|FALSE |FALSE|26 |CWE-  |CallExpression|strerror |357 |-3   |311         |0      |
|before_file-xfers.c|vdagent_file_xfers_data|FALSE |FALSE|47 |CWE-  |CallExpression|write    |326 |-3   |309         |0      |
|before_file-xfers.c|vdagent_file_xfers_data|FALSE |FALSE|48 |CWE-  |CallExpression|syslog   |332 |-3   |246         |0      |
|before_file-xfers.c|vdagent_file_xfers_data|FALSE |FALSE|49 |CWE-  |CallExpression|close    |334 |-3   |246         |0      |
|before_file-xfers.c|vdagent_file_xfers_data|FALSE |FALSE|50 |CWE-  |CallExpression|snprintf |340 |-3   |277         |0      |
|before_file-xfers.c|vdagent_file_xfers_data|FALSE |FALSE|51 |CWE-  |CallExpression|system   |341 |-3   |161         |0      |
|before_file-xfers.c|vdagent_file_xfers_data|FALSE |FALSE|52 |CWE-  |CallExpression|syslog   |345 |-3   |92          |0      |
|before_file-xfers.c|vdagent_file_xfers_data|FALSE |FALSE|53 |CWE-  |CallExpression|syslog   |350 |-3   |246         |0      |
|before_file-xfers.c|vdagent_file_xfers_data|FALSE |FALSE|54 |CWE-  |CallExpression|strerror |350 |-3   |246         |0      |
