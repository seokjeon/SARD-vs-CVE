# ğŸ“ CVE-2018-6791

## ğŸ” ì·¨ì•½ì  ê°œìš”
**ğŸ”— [ì»¤ë°‹ ë§í¬](https://git.ghostscript.com/?p=ghostpdl.git;a=commit;h=79cccf641486)** | **ğŸ”— [CVE ë§í¬](https://www.cvedetails.com/cve/CVE-2018-6791/)** | **[ì·¨ì•½ì  ì¢…ë¥˜: [CWE-78] OS Command Injection](https://cwe.mitre.org/data/definitions/78.html)** 

> 5.12.0 ì´ì „ ë²„ì „ì˜ KDE Plasma Workspaceí”„ë¡œê·¸ë¨ì˜ soliduiserver/deviceserviceaction.cppíŒŒì¼ì—ì„œ ì–´ë–¤ ê¸°ëŠ¥ì— ìˆëŠ” ì–´ë–¤ í•¨ìˆ˜ì—ì„œ ë°œìƒí•œ ë³¼ë¥¨ ë ˆì´ë¸”ì— '' ë˜ëŠ” $()ê°€ í¬í•¨ëœ vfat ì¸ë“œë¼ì´ë¸Œë¥¼ ì¥ì¹˜ ì•Œë¦¬ë¯¸ë¥¼ í†µí•´ ì—°ê²°í•˜ê³  ë§ˆìš´íŠ¸í•˜ë©´ ì…¸ ëª…ë ¹ìœ¼ë¡œ í•´ì„ë˜ì–´ ì„ì˜ì˜ ëª…ë ¹ì´ ì‹¤í–‰ë  ê°€ëŠ¥ì„±ì´ ìˆëŠ” ì·¨ì•½ì ì…ë‹ˆë‹¤.
> ë¬¸ì œ ì˜ˆì‹œ : "$(touch b)" (í™ˆ í´ë”ì— bë¼ëŠ” íŒŒì¼ì„ ë§Œë“ ë‹¤.)

* **ì·¨ì•½ ì¡°ê±´**: ì…ë ¥ê°’ ê²€ì¦ ì—†ì´ ëª…ë ¹ ì‹¤í–‰ ê²½ë¡œì— ì§ì ‘ ì‚¬ìš©ë¨
* **Sink**: runCommand(exec, QString(), m_service.icon(), 0) í•¨ìˆ˜ ì‚¬ìš©

## ë¶„ì„ ê²°ê³¼ ìš”ì•½
cve ì„¤ëª…ì— ë‚˜ì˜¨ ì·¨ì•½í•œ í•¨ìˆ˜(Caller)ì— ëŒ€í•œ ìŠ¬ë¼ì´ìŠ¤ë§Œ ê³ ë ¤í–ˆì„ ë•Œ, 

| ì´ ìŠ¬ë¼ì´ìŠ¤ ìˆ˜ |  ì·¨ì•½ìœ¼ë¡œ íƒì§€ | ì •ìƒìœ¼ë¡œ íƒì§€ |
| --------  | -- | -- |
| 1ê°œ       | 0ê°œ | 1ê°œ |

ì´ì¤‘ Sink(`runCommand()` í•¨ìˆ˜) ê´€ë ¨ ìŠ¬ë¼ì´ìŠ¤ëŠ” 0ê±´ ì¡´ì¬

\* cve ì„¤ëª…ì— ë‚˜ì˜¨ ì·¨ì•½í•œ í•¨ìˆ˜(Caller) && Sinkì™€ ê´€ë ¨ëœ ìŠ¬ë¼ì´ìŠ¤ ë°ì´í„°ë§Œ ì¶”ì¶œ


ì´ CVE ì·¨ì•½ì ì„ ìœ ë°œí•˜ëŠ” ì½”ë“œ(sink:soliduiserver/deviceserviceaction.cpp:161)ëŠ” ì•„ë˜ì™€ ê°™ë‹¤.
```
void DelayedExecutor::delayedExecute(const QString &udi)
{
    Solid::Device device(udi);

    QString exec = m_service.exec();
    MacroExpander mx(device);
    mx.expandMacros(exec);
```
ì´ ì½”ë“œì—ì„œ Ksign ìŠ¬ë¼ì´ì„œ ë„êµ¬ê°€ ì¶”ì¶œí–ˆì–´ì•¼ í•˜ëŠ” ìŠ¬ë¼ì´ìŠ¤ë¥¼ ì§ì ‘ ì‘ì„±í•´ë³´ë©´ ë‹¤ìŒê³¼ ê°™ë‹¤.
```
/* userDefinedServicesëŠ” KDesktopFileActionsì˜ ë©”ì†Œë“œì¸ë° ì´ëŠ” ì™¸ë¶€ ë¼ì´ë¸ŒëŸ¬ë¦¬ì— ìˆëŠ” í´ë˜ìŠ¤ì´ê³ , íŒŒì¼ì—ì„œ ë¶ˆëŸ¬ì˜¤ëŠ” ê²ƒ! */
/* soliduiserver.cpp:77 */
void SolidUiServer::showActionsDialog(const QString &udi,
                                      const QStringList &desktopFiles)
{
    if (m_udiToActionsDialog.contains(udi)) {
    QList<DeviceAction*> actions;
    foreach (const QString &desktop, desktopFiles) {
        const QString filePath = QStandardPaths::locate(QStandardPaths::GenericDataLocation, "solid/actions/"+desktop);

        QList<KServiceAction> services = KDesktopFileActions::userDefinedServices(filePath, true);

        foreach (const KServiceAction &service, services) {
            DeviceServiceAction *action = new DeviceServiceAction();
            action->setService(service);
            actions << action;
        }
    }

    // Only one action, execute directly
    if (actions.size()==1) {
        DeviceAction *action = actions.takeFirst();
        Solid::Device device(udi);
        action->execute(device);


/* soliduiserver/deviceserviceaction.cpp:95 */
void DeviceServiceAction::setService(const KServiceAction& service)
{
    DeviceAction::setIconName(service.icon());
    DeviceAction::setLabel(service.text());

    m_service = service;

/* soliduiserver/deviceserviceaction.h:80 */
class DeviceServiceAction : public DeviceAction
{
public:
    DeviceServiceAction();
    QString id() const override;
    void execute(Solid::Device &device) override;

    void setService(const KServiceAction& service);
    KServiceAction service() const;

private:
    KServiceAction m_service;
};

/* soliduiserver/deviceserviceaction.cpp:77 */
void DeviceServiceAction::execute(Solid::Device &device)
{
    new DelayedExecutor(m_service, device);

/* soliduiserver/deviceserviceaction.cpp:139 */
DelayedExecutor::DelayedExecutor(const KServiceAction &service, Solid::Device &device): m_service(service)

/* soliduiserver/deviceserviceaction.cpp:161 */
void DelayedExecutor::delayedExecute(const QString &udi)
{
    Solid::Device device(udi);

    QString exec = m_service.exec();
    MacroExpander mx(device);
    mx.expandMacros(exec);

    KRun::runCommand(exec, QString(), m_service.icon(), 0);
```
ì´ ìŠ¬ë¼ì´ìŠ¤ë¥¼ ìˆ˜ë™ìœ¼ë¡œ Ksign ëª¨ë¸ì— ì ìš©í•´ì„œ ê²°ê³¼ë¥¼ íƒì§€í•´ë³´ì•˜ë”ë‹ˆ ì •ìƒìœ¼ë¡œ ì˜ˆì¸¡í–ˆë‹¤.

#### SARDëŠ” ì˜ íƒì§€í•˜ëŠ”ë° ì´ CVEëŠ” íƒì§€ ëª»í–ˆë˜ ì´ìœ 

- cve ì„¤ëª…ì— ë‚˜ì˜¨ ë¬¸ì œë¥¼ ì¼ìœ¼í‚¤ëŠ” í•¨ìˆ˜ê°€ l_funcs ë¦¬ìŠ¤íŠ¸ì— ìˆëŠ” í•¨ìˆ˜ê°€ ì•„ë‹ˆê¸° ë•Œë¬¸ì¸ì§€ ì¶”ì¶œì´ ë˜ì§€ ì•ŠìŒ
- í•´ë‹¹ ì½”ë“œê°€ ìˆëŠ” í•¨ìˆ˜ ë‚´ë¶€ì— l_funcs ë¦¬ìŠ¤íŠ¸ì— ìˆëŠ” í•¨ìˆ˜ê°€ ì¡´ì¬í•˜ì§€ ì•Šì•„ ìŠ¤ë‹ˆí« ìƒì„±ì´ ì•ˆëœê²ƒìœ¼ë¡œ ë³´ì„

### íƒì§€ ê²°ê³¼
\* cve ì„¤ëª…ì— ë‚˜ì˜¨ ì·¨ì•½í•œ í•¨ìˆ˜(Caller)ì— ëŒ€í•œ ìŠ¬ë¼ì´ìŠ¤ ê´€ë ¨ ë°ì´í„°ë§Œ ì¶”ì¶œ
ì—†ìŒ

## ì·¨ì•½ì  ì„¸ë¶€ ì‚¬í•­

### ğŸ“ ê´€ë ¨ íŒŒì¼ ì†Œê°œ
íŒŒì¼ í•œê°œ ë©´, ì‘ì„± ì•ˆí•˜ì…”ë„ ë©ë‹ˆë‹¤.
| íŒŒì¼ëª…            | ì„¤ëª…              |
| -------------- | --------------- |
| `before_deviceserviceaction.cpp` | ì·¨ì•½ ì½”ë“œ (ìˆ˜ì • ì „) í¬í•¨ |
| `after_deviceserviceaction.cpp`  | ê°œì„  ì½”ë“œ (ìˆ˜ì • í›„) í¬í•¨ |

---

### â—ï¸ ì·¨ì•½ ì½”ë“œ

**ë¬¸ì œì **:
ì‚¬ìš©ì ì…ë ¥ì´ ì ì ˆíˆ ê²€ì¦ë˜ì§€ ì•Šì€ ì±„ë¡œ `runCommand` í•¨ìˆ˜ì˜ ì¸ìë¡œ ì‚¬ìš©ë˜ì–´ **ëª…ë ¹ì–´ ì¸ì ì…˜**ì´ ë°œìƒí•  ìˆ˜ ìˆìŒ.


#### Sink: `before_deviceserviceaction.cpp:155`
```c
void DelayedExecutor::delayedExecute(const QString &udi)
{
    Solid::Device device(udi);

    QString exec = m_service.exec();
    MacroExpander mx(device);
    mx.expandMacros(exec);

    KRun::runCommand(exec, QString(), m_service.icon(), 0);
    deleteLater();
}
```

### âœ… ê°œì„  ì½”ë“œ

**íŒ¨ì¹˜ ìœ„ì¹˜**: `after_deviceserviceaction.cpp:155`

```c
void DelayedExecutor::delayedExecute(const QString &udi)
{
    Solid::Device device(udi);

    QString exec = m_service.exec();
    MacroExpander mx(device);
    mx.expandMacrosShellQuote(exec);

    KRun::runCommand(exec, QString(), m_service.icon(), 0);
    deleteLater();
}
```

**ê°œì„  ë°©ë²•**:
expandMacrosShellQuote(exec) ì…ë ¥ê°’ì„ ê²€ì¦í•´ì£¼ëŠ” í•¨ìˆ˜ ì‚¬ìš©