# ğŸ“ CVE-2018-16863

## ğŸ” ì·¨ì•½ì  ê°œìš”
**ğŸ”— [ì»¤ë°‹ ë§í¬](https://github.com/ArtifexSoftware/ghostpdl/blob/master/base/gsdevice.c)** | **ğŸ”— [CVE ë§í¬](https://www.cve.org/CVERecord?id=CVE-2018-16863)** | **[ì·¨ì•½ì  ì¢…ë¥˜: [CWE-78] OS Command Injection](https://cwe.mitre.org/data/definitions/78.html)** 

> Red Hat Enterprise Linux 7 í”„ë¡œê·¸ë¨ì˜ NULL ë””ë°”ì´ìŠ¤ë¥¼ íƒìƒ‰í•˜ê³  ì„ íƒí•œ ë‹¤ìŒ ì´ˆê¸°í™”í•˜ëŠ”ëŠ” ê¸°ëŠ¥ì— ìˆëŠ” gs_nulldevice í•¨ìˆ˜ì—ì„œ ë°œìƒí•œ -dSAFER ë³´í˜¸ë¥¼ ìš°íšŒí•˜ì—¬ ì˜ˆë¥¼ ë“¤ì–´ íŠ¹ë³„íˆ ì œì‘ëœ PostScript ë¬¸ì„œë¥¼ í†µí•´ ì„ì˜ì˜ ì…¸ ëª…ë ¹ì„ ì‹¤í–‰í•  ìˆ˜ ìˆëŠ” ì·¨ì•½ì 

> **nulldevice** : PostScriptì—ì„œ ì‚¬ìš©í•˜ëŠ” íŠ¹ìˆ˜ ì¥ì¹˜ë¡œ, ì¶œë ¥ ì‘ì—…ì„ ì•„ë¬´ ê²ƒë„ í•˜ì§€ ì•Šê³  ë¬´ì‹œí•˜ëŠ” ì¥ì¹˜

* **ì·¨ì•½ ì¡°ê±´**: ë³´ì•ˆì„ ìœ„í•œ ì ê¸ˆì„ ë¬´íš¨í™”í•¨ìœ¼ë¡œì¨ ê³µê²©ìê°€ ëª…ë ¹ì–´ë¥¼ ì‹¤í–‰í•  ìˆ˜ ìˆëŠ” í™˜ê²½ì„ ë§Œë“¤ê¸° ë•Œë¬¸ì— **CWE-78 (OS Command Injection)**ìœ¼ë¡œ ë¶„ë¥˜

* **Sink**: ì·¨ì•½ì ì„ ë°œíœ˜í•˜ëŠ” í•¨ìˆ˜ê°€ ìˆëŠ”ê²ƒì€ ì•„ë‹˜. ì´ˆê¸° í™˜ê²½ ì„¸íŒ…ì‹œì‹œì— ë°œìƒí•˜ëŠ” ë¬¸ì œë¡œ ë³´ì•ˆê´€ë ¨ ì¸ìì˜ ê°’ì„ ë°›ì•„ì˜¤ëŠ” ì½”ë“œê°€ ë¯¸ë¹„í•˜ì—¬ ë³´ì•ˆ ì·¨ì•½í•œ ìƒíƒœë¡œ ë§Œë“¦.

## ë¶„ì„ ê²°ê³¼ ìš”ì•½
cve ì„¤ëª…ì— ë‚˜ì˜¨ ì·¨ì•½í•œ í•¨ìˆ˜(Caller)ì— ëŒ€í•œ ìŠ¬ë¼ì´ìŠ¤ë§Œ ê³ ë ¤í–ˆì„ ë•Œ, 

| ì´ ìŠ¬ë¼ì´ìŠ¤ ìˆ˜ |  ì·¨ì•½ìœ¼ë¡œ íƒì§€ | ì •ìƒìœ¼ë¡œ íƒì§€ |
| --------  | -- | -- |
| 0ê°œ       | 0ê°œ | 0ê°œ |

#### SARDëŠ” ì˜ íƒì§€í•˜ëŠ”ë° ì´ CVEëŠ” íƒì§€ ëª»í–ˆë˜ ì´ìœ 
í˜„ì¬ ì·¨ì•½ì ì´ ë°œìƒí•˜ëŠ” í•¨ìˆ˜ gs_nulldevice() ì•ˆì—ëŠ” l_funcs ë¦¬ìŠ¤íŠ¸ì— ìˆëŠ” í•¨ìˆ˜ê°€ ì—†ì–´ criterionì´ ì—†ê¸° ë•Œë¬¸ì— ì¡íˆëŠ”ê²Œ ì—†ë‹¤.

### íƒì§€ ê²°ê³¼
\* cve ì„¤ëª…ì— ë‚˜ì˜¨ ì·¨ì•½í•œ í•¨ìˆ˜(Caller)ì— ëŒ€í•œ ìŠ¬ë¼ì´ìŠ¤ ê´€ë ¨ ë°ì´í„°ë§Œ ì¶”ì¶œ

ì—†ìŒ

## ì·¨ì•½ì  ì„¸ë¶€ ì‚¬í•­

### ğŸ“ ê´€ë ¨ íŒŒì¼ ì†Œê°œ

| íŒŒì¼ëª…            | ì„¤ëª…              |
| -------------- | --------------- |
| `before_device.c` | ì·¨ì•½ ì½”ë“œ (ìˆ˜ì • ì „) í¬í•¨ |
| `after_gsdevice.c`  | ê°œì„  ì½”ë“œ (ìˆ˜ì • í›„) í¬í•¨ |

---

### â—ï¸ ì·¨ì•½ ì½”ë“œ

**ë¬¸ì œì **
- nulldeviceëŠ” setpagedeviceë¥¼ í†µí•´ ì„¤ì •ë˜ëŠ” ê²ƒì´ ì•„ë‹ˆë¼ nulldevice ì—°ì‚°ìë¥¼ í†µí•´ ì§ì ‘ ì„¤ì •ë˜ê¸° ë•Œë¬¸ì—, ì´ì „ ì¥ì¹˜ì˜ ì„¤ì •(ì˜ˆ: LockSafetyParams)ì„ ìœ ì§€ ë¶ˆê°€ëŠ¥
- ë³´í†µ nulldeviceëŠ” ì•„ë¬´ ê²ƒë„ í•˜ì§€ ì•Šê¸° ë•Œë¬¸ì— ì´ëŸ° ì„¤ì •ì´ ë³´ì¡´ë˜ì§€ ì•Šì•„ë„ ë¬¸ì œê°€ ì—†ìœ¼ë‚˜,
LockSafetyParams ì„¤ì •ì€ ì˜ˆì™¸
- ì´ ì„¤ì •ì´ ì´ˆê¸° ì¥ì¹˜ì—ì„œ í™œì„±í™”ë˜ì–´ ìˆì—ˆëŠ”ë°, nulldeviceë¥¼ ì‚¬ìš©í•œ ë’¤ ì›ë˜ ì¥ì¹˜ë¡œ ë³µì›í•  ê²½ìš°, LockSafetyParams ì„¤ì •ì´ ë¹„í™œì„±í™”ëœ ìƒíƒœë¡œ ë³µì›ë˜ê¸° ë•Œë¬¸ì— ë¬¸ì œê°€ ë°œìƒ

#### Sink: `before_gsdive.c:731`
```c
int
gs_nulldevice(gs_gstate * pgs)
{
    int code = 0;

    if (pgs->device == 0 || !gx_device_is_null(pgs->device)) {
        gx_device *ndev;
        code = gs_copydevice(&ndev, (const gx_device *)&gs_null_device,
                                 pgs->memory);

        if (code < 0)
            return code;
        rc_init(ndev, pgs->memory, 0);
        if (pgs->device != NULL) {
            if ((code = dev_proc(pgs->device, get_profile)(pgs->device,
                                               &(ndev->icc_struct))) < 0)
                return code;
            rc_increment(ndev->icc_struct);
            set_dev_proc(ndev, get_profile, gx_default_get_profile);
        }

        if ((code = gs_setdevice_no_erase(pgs, ndev)) < 0)
            gs_free_object(pgs->memory, ndev, "gs_copydevice(device)");
    }
    return code;
}
```

### âœ… ê°œì„  ì½”ë“œ

**íŒ¨ì¹˜ ìœ„ì¹˜**: `before_gsdevice.c:690`

```c
int
gs_nulldevice(gs_gstate * pgs)
{
    int code = 0;
    gs_gstate *spgs;
    bool saveLockSafety = false;
    if (pgs->device == NULL || !gx_device_is_null(pgs->device)) {
        gx_device *ndev;
        code = gs_copydevice(&ndev, (const gx_device *)&gs_null_device,
                                 pgs->memory);

        if (code < 0)
            return code;
        if (gs_currentdevice_inline(pgs) != NULL)
            saveLockSafety = gs_currentdevice_inline(pgs)->LockSafetyParams;
        rc_init(ndev, pgs->memory, 0);
        if (pgs->device != NULL) {
            if ((code = dev_proc(pgs->device, get_profile)(pgs->device,
                                               &(ndev->icc_struct))) < 0)
                return code;
            rc_increment(ndev->icc_struct);
            set_dev_proc(ndev, get_profile, gx_default_get_profile);
        }

        if (gs_setdevice_no_erase(pgs, ndev) < 0) {
            gs_free_object(pgs->memory, ndev, "gs_copydevice(device)");

            spgs = pgs->saved;
            if (spgs != NULL) {
                while (spgs->saved) spgs = spgs->saved;
                gs_currentdevice_inline(pgs) = gs_currentdevice_inline(spgs);
                rc_increment(gs_currentdevice_inline(pgs));
            }
            code = gs_note_error(gs_error_Fatal);
        }
        if (gs_currentdevice_inline(pgs) != NULL)
            gs_currentdevice_inline(pgs)->LockSafetyParams = saveLockSafety;
    }
    return code;
}
```

**ê°œì„  ë°©ë²•**:
* LockSafetyParams ê°’ì„ ê¸°ë³¸ì ìœ¼ë¡œ false(ë¹„í™œì„±í™”)ë¡œ ì´ˆê¸°í™”í•˜ë˜, ì¥ì¹˜ë¥¼ ë³µì›í•  ë•Œ ì´ ê°’ì´ ìœ ì§€ë˜ë„ë¡ ëª…ì‹œì ìœ¼ë¡œ ë³µì‚¬/ìœ ì§€

--
### ë¶€ì—°ì„¤ëª…
**ê³µê²©ì‹œë‚˜ë¦¬ì˜¤**
1. ì‹œìŠ¤í…œì€ ë³´ì•ˆì„ ìœ„í•´ LockSafetyParamsë¥¼ trueë¡œ ì„¤ì •í•¨.
2. ì–´ë–¤ ì´ìœ ë¡œ nulldeviceê°€ ì‚¬ìš©ë¨.
3. ë³µì› í›„ LockSafetyParamsê°€ falseë¡œ ë°”ë€œ.
4. ì´ ì‹œì ë¶€í„°ëŠ” ê³µê²©ìê°€ PostScriptë‚˜ PDF ë‚´ì—ì„œ **ëª…ë ¹ì–´ ì‹¤í–‰ ê¸°ëŠ¥(system call)**ì„ ì‚¬ìš©í•  ìˆ˜ ìˆê²Œ ë¨.
5. ì´ë¡œ ì¸í•´ OS ëª…ë ¹ì–´ê°€ ì‚½ì…/ì‹¤í–‰ ê°€ëŠ¥í•´ì§ â†’ CWE-78ì˜ ì •ì˜ì— í•´ë‹¹