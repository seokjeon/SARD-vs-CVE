# üìÅ CVE-2017-15924

## üîç Ï∑®ÏïΩÏ†ê Í∞úÏöî

**üîó [Ïª§Î∞ã ÎßÅÌÅ¨](https://github.com/shadowsocks/shadowsocks-libev/commit/c67d275803dc6ea22c558d06b1f7ba9f94cd8de3)** | **üîó [CVE ÎßÅÌÅ¨](https://www.cvedetails.com/cve/CVE-2017-15924/)** | **üîó [CWE ÎßÅÌÅ¨](https://cwe.mitre.org/data/definitions/78.html)**

> shadowsocks-libev 3.1.0Ïùò ss-managerÏóêÏÑú 127.0.0.1 UDP Ìä∏ÎûòÌîΩÏùÑ ÌÜµÌï¥ ÏàòÏã†Îêú JSON ÏÑ§Ï†ï ÏöîÏ≤≠Ïùò Î∂ÄÏ†ÅÏ†àÌïú ÌååÏã±ÏúºÎ°ú Ïù∏Ìï¥ Ïâò Î©îÌÉÄÎ¨∏ÏûêÎ•º ÌÜµÌïú Î™ÖÎ†πÏñ¥ Ïù∏Ï†ùÏÖòÏù¥ Í∞ÄÎä•Ìïú OS Command Injection Ï∑®ÏïΩÏ†êÏûÖÎãàÎã§.

‚Äª Shadowsocks-libevÎäî ÏûÑÎ≤†ÎîîÎìú Ïû•ÏπòÏôÄ Ï†ÄÏÇ¨Ïñë Î∞ïÏä§Î•º ÏúÑÌïú Í≤ΩÎüâ Î≥¥Ïïà SOCKS5 ÌîÑÎ°ùÏãúÏûÖÎãàÎã§. ss-managerÎäî Îã§Ï§ë ÏÇ¨Ïö©ÏûêÎ•º ÏúÑÌïú shadowsocks ÏÑúÎ≤ÑÎ•º Ï†úÏñ¥ÌïòÎ©∞, ÌïÑÏöîÏóê Îî∞Îùº ÏÉàÎ°úÏö¥ ÏÑúÎ≤ÑÎ•º ÏÉùÏÑ±Ìï©ÎãàÎã§.

* **Source**: `get_server()` Ìï®Ïàò ÏµúÏÉÅÎã®ÏóêÏÑú JSON ÌååÏã± ÌõÑ `server->port`, `server->method` Îì±Ïùò Ïô∏Î∂ÄÍ∞íÏùÑ Í≤ÄÏ¶ùÏóÜÏù¥ Î≥µÏÇ¨Ìï®
* **Ï∑®ÏïΩ Ï°∞Í±¥**: JSON ÏÑ§Ï†ï ÏöîÏ≤≠Ïùò `method` ÌååÎùºÎØ∏ÌÑ∞ÏóêÏÑú ÏûÖÎ†•Í∞í Í≤ÄÏ¶ù ÏóÜÏù¥ Ïâò Î™ÖÎ†πÏñ¥ Íµ¨ÏÑ±
* **Trace**: `struct_command_line()` Ìï®ÏàòÎäî `get_server()` Ìï®ÏàòÏóêÏÑú Í≤ÄÏ¶ùÎêòÏßÄ ÏïäÍ≥† Î≥µÏÇ¨Îêú ÏûÖÎ†•Í∞í `server->method`, `server->port`ÏùÑ `snprintf()` Ìï®ÏàòÏùò `%s` Ìè¨Îß∑Ïóê ÏßÅÏ†ë ÏÇ¨Ïö© -> Ïâò Î©îÌÉÄÎ¨∏Ïûê ÏÇΩÏûÖ Î≤°ÌÑ∞ Î∞úÏÉù
* **Sink**: `add_server()` Ìï®ÏàòÎäî `construct_command_line()`Î°úÎ∂ÄÌÑ∞ Î∞òÌôòÎêú `cmd` Î•º  `system()` Ìï®ÏàòÏùò Ïù∏ÏûêÎ°ú Ï†ÑÎã¨Ìï®

---

## ÌÉêÏßÄ Í≤∞Í≥º ÏöîÏïΩ
CVE ÏÑ§Î™ÖÏóê ÎÇòÏò® Ï∑®ÏïΩÌïú Ìï®ÏàòÎì§(add_server, build_config, construct_command_line)Ïóê ÎåÄÌïú Ïä¨ÎùºÏù¥Ïä§Îßå Í≥†Î†§ÌñàÏùÑ Îïå,

| Ï¥ù Ïä¨ÎùºÏù¥Ïä§ Ïàò |  Ï∑®ÏïΩÏúºÎ°ú ÌÉêÏßÄ | Ï†ïÏÉÅÏúºÎ°ú ÌÉêÏßÄ |
| --------  | -- | -- |
| 48Í∞ú       | 0Í∞ú | 48Í∞ú |

add_server(), build_config(), construct_command_line()ÏóêÏÑú Ï∂îÏ∂úÌïú Ïä¨ÎùºÏù¥Ïä§ Ï§ë, Sink(`system()` Ìï®Ïàò) Í¥ÄÎ†® Ïä¨ÎùºÏù¥Ïä§Îäî 1Í±¥ ÏûàÏóàÏúºÎÇò, **Ï†ïÏÉÅÏúºÎ°ú ÌÉêÏßÄÎê®**

|FileName |Caller                |Source|Sink |idx|CWE-ID|category      |criterion|line|label|token_length|predict|
|---------|----------------------|------|-----|---|------|--------------|---------|----|-----|------------|-------|
|manager.c|add_server            |False |False|71 |CWE-  |CallExpression|system   |486 |-3   |67          |0      |

#### SARDÎäî Ïûò ÌÉêÏßÄÌïòÎäîÎç∞ Ïù¥ CVEÎäî ÌÉêÏßÄ Î™ªÌñàÎçò Ïù¥Ïú†

1. **Ïä¨ÎùºÏù¥Ïã± Î≤îÏúÑ Î∂àÏôÑÏ†Ñ**
   - Ïä¨ÎùºÏù¥Ïä§Í∞Ä `system()` Ìï®ÏàòÎ•º criterion ÏúºÎ°ú Ïù∏ÏãùÌïòÏó¨ Ïä¨ÎùºÏù¥Ïã±ÌñàÏúºÎÇò Î≤îÏúÑÏóê `system()` Ìï®ÏàòÍ∞Ä Ìè¨Ìï®ÎêòÏßÄ ÏïäÍ≥† ÏßÅÏ†Ñ ÎùºÏù∏ÍπåÏßÄÎßå ÏΩîÎìúÎ•º Ïä¨ÎùºÏù¥Ïã±Ìï®.
   - ÏÑ§Î†π Ïä¨ÎùºÏù¥Ïä§Ïóê `system()` Ìï®ÏàòÍ∞Ä Ìè¨Ìï®ÎêòÏóàÎçîÎùºÎèÑ Ïù∏Ïûê cmdÏùò Ï°∞Ìï© Í≥ºÏ†ïÏù¥ 300ÎùºÏù∏ Ïù¥ÏÉÅ Îñ®Ïñ¥ÏßÑ ÏúÑÏπòÏóêÏÑú ÏßÑÌñâÎêòÏñ¥ Ïä¨ÎùºÏù¥Ïä§ Î≤îÏúÑÏóê Ìè¨Ìï®ÎêòÏßÄ ÏïäÏùå.
   - ÎïåÎ¨∏Ïóê CVE-2017-15924Ïùò ÏõêÏù∏ Î∂ÑÏÑùÏùÑ ÏúÑÌï¥ÏÑúÎäî sourceÏôÄ trace, sink Î™®Îëê Ìè¨Ìï®Îêú Ïä¨ÎùºÏù¥Ïä§Í∞Ä ÌïÑÏöîÌï®.
        Í∏∞ÎåÄÌïòÎäî Ïä¨ÎùºÏù¥Ïä§
        ```
        static struct server *
        get_server(char *buf, int len)
        {...
                struct server *server = ss_malloc(sizeof(struct server));
                memset(server, 0, sizeof(struct server));
                if (obj->type == json_object) {
                        int i = 0;
                        for (i = 0; i < obj->u.object.length; i++) {
                        char *name        = obj->u.object.values[i].name;
                        json_value *value = obj->u.object.values[i].value;
                        if (strcmp(name, "server_port") == 0) {
                                if (value->type == json_string) {
                                strncpy(server->port, value->u.string.ptr, 8);
                                } else if (value->type == json_integer) {
                                snprintf(server->port, 8, "%" PRIu64 "", value->u.integer);
                                }
                        ...
                        } else if (strcmp(name, "method") == 0) {
                                if (value->type == json_string) {
                                server->method = strdup(value->u.string.ptr);
                                }
                ...
                json_value_free(obj);
                return server;
        }

        construct_command_line(struct manager_ctx *manager, struct server *server)
        {
                static char cmd[BUF_SIZE];
                char *method = manager->method;
                int i;

                build_config(working_dir, server);

                if (server->method) method = server->method;
                memset(cmd, 0, BUF_SIZE);
                snprintf(cmd, BUF_SIZE,
                        "%s -m %s --manager-address %s -f %s/.shadowsocks_%s.pid -c %s/.shadowsocks_%s.conf",
                        executable, method, manager->manager_address,
                        working_dir, server->port, working_dir, server->port);
                ...
                return cmd;
        }

        ...

        add_server(struct manager_ctx *manager, struct server *server)
        {
                ...
                char *cmd = construct_command_line(manager, server);
                if (system(cmd) == -1) {
                        ERROR("add_server_system");
                        return -1;
                }

                return 0;
        }
        ```
        ÏõêÎ≥∏ Ïä¨ÎùºÏù¥Ïä§

        ```c
        {
        "FileName": "manager.c",
        "Caller": "add_server",
        "Source": false,
        "Sink": false,
        "idx": 71,
        "CWE-ID": "CWE-",
        "category": "CallExpression",
        "criterion": "system",
        "line": 486,
        "label": -3,
        "slices": [
            "add_server(struct manager_ctx *manager, struct server *server)\n",
            "    int ret = check_port(manager, server);\n",
            "    if (ret == -1) {\n",
            "    char *cmd = construct_command_line(manager, server);\n"
        ]
        }
        ```

---

## Ï∑®ÏïΩÏ†ê ÏÑ∏Î∂Ä ÏÇ¨Ìï≠

### üìÅ Í¥ÄÎ†® ÌååÏùº ÏÜåÍ∞ú
| ÌååÏùºÎ™Ö            | ÏÑ§Î™Ö              |
| -------------- | --------------- |
| `before_manager.c` | Ï∑®ÏïΩ ÏΩîÎìú (ÏàòÏ†ï Ï†Ñ) Ìè¨Ìï® |
| `after_manager.c`  | Í∞úÏÑ† ÏΩîÎìú (ÏàòÏ†ï ÌõÑ) Ìè¨Ìï® |

---

### ‚ùóÔ∏è Ï∑®ÏïΩ ÏΩîÎìú

#### Source: `before_manager.c:265-285`
```c 
static struct server *
get_server(char *buf, int len)
{
        //...
        struct server *server = ss_malloc(sizeof(struct server));
        memset(server, 0, sizeof(struct server));
        if (obj->type == json_object) {
                int i = 0;
                for (i = 0; i < obj->u.object.length; i++) {
                char *name        = obj->u.object.values[i].name;
                json_value *value = obj->u.object.values[i].value;
                if (strcmp(name, "server_port") == 0) {
                        if (value->type == json_string) {
                        strncpy(server->port, value->u.string.ptr, 8);
                        } else if (value->type == json_integer) {
                        snprintf(server->port, 8, "%" PRIu64 "", value->u.integer);
                        }
                //...
                } else if (strcmp(name, "method") == 0) {
                        if (value->type == json_string) {
                        server->method = strdup(value->u.string.ptr);
                        }
        //...
        json_value_free(obj);
        return server;
}

```

**Î¨∏Ï†úÏ†ê**: JSON ÏÑ§Ï†ï ÏöîÏ≤≠Ïù¥ÎÇò ÏÑ§Ï†ï ÌååÏùºÏóêÏÑú ÌååÏã±Îêú Ïù∏ÏûêÎì§Ïù¥ Ï†ÅÏ†àÌïú Í≤ÄÏ¶ù ÏóÜÏù¥ `add_server` Ìï®ÏàòÎ°ú Ï†ÑÎã¨ÎêòÏñ¥ **Î™ÖÎ†πÏñ¥ Ïù∏Ï†ùÏÖò**Ïù¥ Î∞úÏÉùÌï† Ïàò ÏûàÏäµÎãàÎã§.

#### Trace: `before_manager.c:124-137`
```c
static char *
construct_command_line(struct manager_ctx *manager, struct server *server)
{
    static char cmd[BUF_SIZE];
    char *method = manager->method;
    
    build_config(working_dir, server);
    
    if (server->method) method = server->method;
    memset(cmd, 0, BUF_SIZE);
    snprintf(cmd, BUF_SIZE,
             "%s -m %s --manager-address %s -f %s/.shadowsocks_%s.pid -c %s/.shadowsocks_%s.conf",
             executable, method, manager->manager_address,
             working_dir, server->port, working_dir, server->port);
    // ...
}         
```

#### Sink: `before_manager.c:486`
```c
static int
add_server(struct manager_ctx *manager, struct server *server)
{
    // ...
    char *cmd = construct_command_line(manager, server);
    if (system(cmd) == -1) { 
        ERROR("add_server_system");
        return -1;
    }
    return 0;
}
```

---

### ‚úÖ Í∞úÏÑ† ÏΩîÎìú

#### 1. **Ìå®Ïπò ÏúÑÏπò**: `build_config.c:95,113-124`

```c
build_config(char *prefix, struct manager_ctx *manager, struct server *server)
{
//...
    if (server->method)
        fprintf(f, ",\n\"method\":\"%s\"", server->method);
    else if (manager->method)
        fprintf(f, ",\n\"method\":\"%s\"", manager->method);
    if (server->fast_open[0])
        fprintf(f, ",\n\"fast_open\": %s", server->fast_open);
    if (server->mode)
        fprintf(f, ",\n\"mode\":\"%s\"", server->mode);
    if (server->plugin)
        fprintf(f, ",\n\"plugin\":\"%s\"", server->plugin);
    if (server->plugin_opts)
        fprintf(f, ",\n\"plugin_opts\":\"%s\"", server->plugin_opts);
//...
}
```

**Í∞úÏÑ† Î∞©Î≤ï**:
`manager` Ï†ïÎ≥¥Î•º Ìï®Íªò Î∞õÏïÑÏÑú, `server->method`Í∞Ä ÏóÜÏùÑ Îïå Í¥ÄÎ¶¨Ïûê ÏÑ§Ï†ï(`manager->method`) ÏùÑ ÎåÄÏ≤¥ ÏÇ¨Ïö©Ìï† Ïàò ÏûàÍ≤å Ìï©ÎãàÎã§.
* `build_config()` Ìï®ÏàòÏóê `manager` ÌååÎùºÎØ∏ÌÑ∞Î•º Ï∂îÍ∞ÄÌïòÏó¨ Ï†ÑÏó≠ ÏÑ§Ï†ïÏóê Ï†ëÍ∑º Í∞ÄÎä•
* `server->method`Í∞Ä ÏóÜÏùÑ Í≤ΩÏö∞ `manager->method`Î•º ÏÇ¨Ïö©ÌïòÎäî ÏïàÏ†ÑÌïú ÎåÄÏ≤¥ Î°úÏßÅ Íµ¨ÌòÑ
* `method` Í∞íÏùÑ ÏÑ§Ï†ï ÌååÏùºÏóêÎßå Í∏∞Î°ùÌïòÏó¨ Í∏∞Ï°¥ `-m %s` ÏòµÏÖòÏúºÎ°ú Ï†ÑÎã¨ÌïòÏßÄ ÏïäÍ≥† JSON config ÌååÏùº ÏïàÏóêÎßå ÎÇ®ÎèÑÎ°ù Í¥ÄÎ¶¨

#### 2. **Ìå®Ïπò ÏúÑÏπò**: `after_manager.c:142-144`

```c
static char *
construct_command_line(struct manager_ctx *manager, struct server *server)
{
    static char cmd[BUF_SIZE];
    int i;
    int port;

    port = atoi(server->port);

    build_config(working_dir, manager, server);

    memset(cmd, 0, BUF_SIZE);
    snprintf(cmd, BUF_SIZE,
             "%s --manager-address %s -f %s/.shadowsocks_%d.pid -c %s/.shadowsocks_%d.conf",
             executable, manager->manager_address, working_dir, port, working_dir, port);
}
```

**Í∞úÏÑ† Î∞©Î≤ï**:

Ïù¥ Ìå®ÏπòÎäî Î™ÖÎ†πÏñ¥ Ïù∏Ï†ùÏÖòÏùò ÏßÅÏ†ëÏ†ÅÏù∏ Í≤ΩÎ°úÎ•º Ï∞®Îã®Ìï©ÎãàÎã§.

* `-m %s` ÏòµÏÖò Ï†úÍ±∞: `method` ÌååÎùºÎØ∏ÌÑ∞Î•º Î™ÖÎ†πÏ§ÑÏóêÏÑú ÏôÑÏ†ÑÌûà Ï†úÍ±∞ÌïòÏó¨ Ïù∏Ï†ùÏÖò Î≤°ÌÑ∞ Ï∞®Îã®.
* Ï†ïÏàò Î≥ÄÌôò: `server->port`Î•º `atoi()`Î°ú Ï†ïÏàò Î≥ÄÌôòÌïòÏó¨ Î¨∏ÏûêÏó¥ Ïù∏Ï†ùÏÖò Î∞©ÏßÄ.


---

## ÌÉêÏßÄ Í≤∞Í≥º

|FileName |Caller                |Source|Sink |idx|CWE-ID|category      |criterion|line|label|token_length|predict|
|---------|----------------------|------|-----|---|------|--------------|---------|----|-----|------------|-------|
|manager.c|build_config          |FALSE |FALSE|0  |CWE-  |CallExpression|strlen   |98  |-3   |375         |0      |
|manager.c|build_config          |FALSE |FALSE|1  |CWE-  |CallExpression|strlen   |98  |-3   |375         |0      |
|manager.c|build_config          |FALSE |FALSE|2  |CWE-  |CallExpression|snprintf |101 |-3   |350         |0      |
|manager.c|build_config          |FALSE |FALSE|3  |CWE-  |CallExpression|fopen    |102 |-3   |375         |0      |
|manager.c|build_config          |FALSE |FALSE|4  |CWE-  |CallExpression|fprintf  |110 |-3   |338         |0      |
|manager.c|build_config          |FALSE |FALSE|5  |CWE-  |CallExpression|fprintf  |111 |-3   |359         |0      |
|manager.c|build_config          |FALSE |FALSE|6  |CWE-  |CallExpression|atoi     |111 |-3   |359         |0      |
|manager.c|build_config          |FALSE |FALSE|7  |CWE-  |CallExpression|fprintf  |112 |-3   |359         |0      |
|manager.c|build_config          |FALSE |FALSE|8  |CWE-  |CallExpression|fprintf  |113 |-3   |323         |0      |
|manager.c|build_config          |FALSE |FALSE|9  |CWE-  |CallExpression|fprintf  |114 |-3   |323         |0      |
|manager.c|build_config          |FALSE |FALSE|10 |CWE-  |CallExpression|fprintf  |115 |-3   |323         |0      |
|manager.c|build_config          |FALSE |FALSE|11 |CWE-  |CallExpression|fprintf  |116 |-3   |323         |0      |
|manager.c|build_config          |FALSE |FALSE|12 |CWE-  |CallExpression|fprintf  |117 |-3   |323         |0      |
|manager.c|build_config          |FALSE |FALSE|13 |CWE-  |CallExpression|fprintf  |118 |-3   |338         |0      |
|manager.c|build_config          |FALSE |FALSE|14 |CWE-  |CallExpression|fclose   |119 |-3   |338         |0      |
|manager.c|construct_command_line|FALSE |FALSE|15 |CWE-  |CallExpression|memset   |133 |-3   |904         |0      |
|manager.c|construct_command_line|FALSE |FALSE|16 |CWE-  |CallExpression|snprintf |134 |-3   |957         |0      |
|manager.c|construct_command_line|FALSE |FALSE|17 |CWE-  |CallExpression|strlen   |140 |-3   |904         |0      |
|manager.c|construct_command_line|FALSE |FALSE|18 |CWE-  |CallExpression|snprintf |141 |-3   |926         |0      |
|manager.c|construct_command_line|FALSE |FALSE|19 |CWE-  |CallExpression|strlen   |144 |-3   |904         |0      |
|manager.c|construct_command_line|FALSE |FALSE|20 |CWE-  |CallExpression|snprintf |145 |-3   |926         |0      |
|manager.c|construct_command_line|FALSE |FALSE|21 |CWE-  |CallExpression|strlen   |149 |-3   |904         |0      |
|manager.c|construct_command_line|FALSE |FALSE|22 |CWE-  |CallExpression|snprintf |150 |-3   |926         |0      |
|manager.c|construct_command_line|FALSE |FALSE|23 |CWE-  |CallExpression|strlen   |154 |-3   |904         |0      |
|manager.c|construct_command_line|FALSE |FALSE|24 |CWE-  |CallExpression|snprintf |155 |-3   |926         |0      |
|manager.c|construct_command_line|FALSE |FALSE|25 |CWE-  |CallExpression|strlen   |158 |-3   |904         |0      |
|manager.c|construct_command_line|FALSE |FALSE|26 |CWE-  |CallExpression|snprintf |159 |-3   |904         |0      |
|manager.c|construct_command_line|FALSE |FALSE|27 |CWE-  |CallExpression|strlen   |162 |-3   |904         |0      |
|manager.c|construct_command_line|FALSE |FALSE|28 |CWE-  |CallExpression|snprintf |163 |-3   |904         |0      |
|manager.c|construct_command_line|FALSE |FALSE|29 |CWE-  |CallExpression|strlen   |166 |-3   |904         |0      |
|manager.c|construct_command_line|FALSE |FALSE|30 |CWE-  |CallExpression|snprintf |167 |-3   |904         |0      |
|manager.c|construct_command_line|FALSE |FALSE|31 |CWE-  |CallExpression|strlen   |170 |-3   |904         |0      |
|manager.c|construct_command_line|FALSE |FALSE|32 |CWE-  |CallExpression|snprintf |171 |-3   |904         |0      |
|manager.c|construct_command_line|FALSE |FALSE|33 |CWE-  |CallExpression|strlen   |174 |-3   |904         |0      |
|manager.c|construct_command_line|FALSE |FALSE|34 |CWE-  |CallExpression|snprintf |175 |-3   |904         |0      |
|manager.c|construct_command_line|FALSE |FALSE|35 |CWE-  |CallExpression|strlen   |178 |-3   |904         |0      |
|manager.c|construct_command_line|FALSE |FALSE|36 |CWE-  |CallExpression|snprintf |179 |-3   |926         |0      |
|manager.c|construct_command_line|FALSE |FALSE|37 |CWE-  |CallExpression|strlen   |182 |-3   |904         |0      |
|manager.c|construct_command_line|FALSE |FALSE|38 |CWE-  |CallExpression|snprintf |183 |-3   |926         |0      |
|manager.c|construct_command_line|FALSE |FALSE|39 |CWE-  |CallExpression|strlen   |186 |-3   |904         |0      |
|manager.c|construct_command_line|FALSE |FALSE|40 |CWE-  |CallExpression|snprintf |187 |-3   |926         |0      |
|manager.c|construct_command_line|FALSE |FALSE|41 |CWE-  |CallExpression|strlen   |190 |-3   |904         |0      |
|manager.c|construct_command_line|FALSE |FALSE|42 |CWE-  |CallExpression|snprintf |191 |-3   |926         |0      |
|manager.c|construct_command_line|FALSE |FALSE|43 |CWE-  |CallExpression|strlen   |194 |-3   |904         |0      |
|manager.c|construct_command_line|FALSE |FALSE|44 |CWE-  |CallExpression|snprintf |195 |-3   |926         |0      |
|manager.c|construct_command_line|FALSE |FALSE|45 |CWE-  |CallExpression|strlen   |199 |-3   |904         |0      |
|manager.c|construct_command_line|FALSE |FALSE|46 |CWE-  |CallExpression|snprintf |200 |-3   |904         |0      |
|manager.c|add_server            |FALSE |FALSE|71 |CWE-  |CallExpression|system   |486 |-3   |67          |0      |