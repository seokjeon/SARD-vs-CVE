# ğŸ“ CVE-2018-20784

## ğŸ” ì·¨ì•½ì  ê°œìš”

ğŸ”— [ì»¤ë°‹ ë§í¬](https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=0f8cf3b8497dc45c010c44ed9e96518e11e19fc3) | ğŸ”— [CVE ë§í¬](https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2018-20784) | ğŸ”— [CWE ë§í¬ (CWE-400)](https://cwe.mitre.org/data/definitions/400.html)

Linux ì»¤ë„ Completely Fair Scheduler(CFS)ì˜ `update_blocked_averages()` í•¨ìˆ˜ì—ì„œ,
ë¦¬ìŠ¤íŠ¸ ìˆœíšŒ ë£¨í”„(`for_each_leaf_cfs_rq_safe`)ê°€ ë¦¬ìŠ¤íŠ¸ ì†ìƒ ì‹œ ì¢…ë£Œë˜ì§€ ì•Šê³ 
\*\*ë¬´í•œ ë£¨í”„ì— ë¹ ì ¸ ì„œë¹„ìŠ¤ ê±°ë¶€(DoS)\*\*ë¥¼ ìœ ë°œí•˜ëŠ” ì·¨ì•½ì ì…ë‹ˆë‹¤.

**ì·¨ì•½ì  ì¢…ë¥˜:** \[CWE-400] Uncontrolled Resource Consumption

* **Source:** CFS ëŸ°í ë¦¬ìŠ¤íŠ¸ `rq->leaf_cfs_rq_list`
* **ì·¨ì•½ ì¡°ê±´:** ë¦¬ìŠ¤íŠ¸ ë¬´ê²°ì„±ì´ ì†ìƒëœ ê²½ìš° ìˆœíšŒ í¬ì¸í„°(`pos`)ê°€ ì •ìƒ ê°±ì‹ ë˜ì§€ ì•ŠìŒ
* **Sink:** `for_each_leaf_cfs_rq_safe` ë§¤í¬ë¡œ ë°˜ë³µë¬¸ì´ ì¢…ë£Œë˜ì§€ ì•Šê³  ë¬´í•œ ë°˜ë³µ

---

## íƒì§€ ê²°ê³¼ ìš”ì•½

CVE ì„¤ëª…ì— ê¸°ë°˜í•´ `update_blocked_averages()` í•¨ìˆ˜ ì¤‘ì‹¬ìœ¼ë¡œ ìŠ¬ë¼ì´ìŠ¤ë¥¼ ìˆ˜ì§‘í•œ ê²°ê³¼:

| ì´ ìŠ¬ë¼ì´ìŠ¤ ìˆ˜ | ì·¨ì•½ìœ¼ë¡œ íƒì§€ | ì •ìƒìœ¼ë¡œ íƒì§€ |
| :------: | :-----: | :-----: |
|    5ê°œ    |    2ê°œ   |    3ê°œ   |

`update_blocked_averages()` í•¨ìˆ˜ ë‚´ `for_each_leaf_cfs_rq_safe` ë°˜ë³µë¬¸ì— ëŒ€í•œ ìŠ¬ë¼ì´ìŠ¤ëŠ” **ì¡´ì¬í•˜ì§€ ì•ŠìŒ**.
íƒì§€ëœ ìŠ¬ë¼ì´ìŠ¤ëŠ” ëª¨ë‘ `memset()` í˜¸ì¶œ ë‹¨ìœ„ë¡œ êµ¬ì„±ë˜ì–´ ìˆìŒ.

| FileName       | Caller                          | Source |  Sink | idx | CWE-ID |    category    | criterion | line | label | token\_length | predict |
| :------------- | :------------------------------ | :----: | :---: | :-: | :----: | :------------: | :-------: | :--: | :---: | :-----------: | :-----: |
| before\_fair.c | init\_entity\_runnable\_average |  False | False |  0  |  CWE-  | CallExpression |   memset  |  703 |   -3  |       85      |    1    |
| before\_fair.c | update\_numa\_stats             |  False | False |  1  |  CWE-  | CallExpression |   memset  | 1476 |   -3  |       95      |    1    |
| before\_fair.c | update\_task\_scan\_period      |  False | False |  2  |  CWE-  | CallExpression |   memset  | 1978 |   -3  |      409      |    0    |
| before\_fair.c | task\_numa\_fault               |  False | False |  3  |  CWE-  | CallExpression |   memset  | 2375 |   -3  |      419      |    0    |
| before\_fair.c | update\_sg\_lb\_stats           |  False | False |  4  |  CWE-  | CallExpression |   memset  | 8172 |   -3  |      390      |    0    |

---

## SARDëŠ” ì˜ íƒì§€í•˜ëŠ”ë° ì´ CVEëŠ” íƒì§€ ëª»í–ˆë˜ ì´ìœ 

**1. ìŠ¬ë¼ì´ìŠ¤ ì¶”ì¶œ ê¸°ì¤€ í•œê³„**

* ë³¸ ì·¨ì•½ì ì€ `for_each_leaf_cfs_rq_safe` ë§¤í¬ë¡œ ê¸°ë°˜ ë°˜ë³µë¬¸ ë‚´ë¶€ì—ì„œ ë°œìƒí•˜ì§€ë§Œ,
  ìŠ¬ë¼ì´ì„œëŠ” **í•¨ìˆ˜ í˜¸ì¶œ(CallExpression)** ë‹¨ìœ„ë¡œ ìŠ¬ë¼ì´ìŠ¤ë¥¼ ìƒì„±.
* ë¦¬ìŠ¤íŠ¸ ìˆœíšŒ íë¦„ê³¼ í¬ì¸í„°(`pos`) ê°±ì‹  ì—¬ë¶€ëŠ” ìŠ¬ë¼ì´ìŠ¤ì— í¬í•¨ë˜ì§€ ëª»í•˜ê³ ,
  `memset()` í˜¸ì¶œ ë“± ë‹¨í¸ì ì¸ ì½”ë“œ ì¡°ê°ë§Œ ìŠ¬ë¼ì´ìŠ¤ë¡œ ìƒì„±ë¨.

> ğŸ“„ ê¸°ëŒ€í•˜ëŠ” ìŠ¬ë¼ì´ìŠ¤:
>
> ```c
> for_each_leaf_cfs_rq_safe(rq, cfs_rq, pos) {
>     ...
> }
> ```

> ğŸ“„ ì‹¤ì œ ìŠ¬ë¼ì´ìŠ¤:
>
> ```c
> memset(&cfs_rq->avg, 0, sizeof(cfs_rq->avg));
> ```

---

**2. ë¦¬ìŠ¤íŠ¸ ìˆœíšŒ ì¡°ê±´ ë³€ìˆ˜ ì¶”ì  ì‹¤íŒ¨**

* **`rq->leaf_cfs_rq_list`**: ìŠ¤ì¼€ì¤„ëŸ¬ ëŸ°íì˜ leaf runqueue ë¦¬ìŠ¤íŠ¸.
* **`pos` í¬ì¸í„°**: ë¦¬ìŠ¤íŠ¸ ë…¸ë“œë¥¼ ìˆœíšŒí•˜ë©´ì„œ ë‹¤ìŒ ë…¸ë“œë¥¼ ê°€ë¦¬ì¼œì•¼ í•˜ì§€ë§Œ,
  ë¦¬ìŠ¤íŠ¸ ì†ìƒ ì‹œ ì •ìƒ ê°±ì‹ ë˜ì§€ ì•ŠìŒ â†’ ë¬´í•œ ë£¨í”„ ë°œìƒ.

ì •ìƒ íë¦„:

* `pos`ê°€ ë¦¬ìŠ¤íŠ¸ì˜ ë‹¤ìŒ ì—”íŠ¸ë¦¬ë¥¼ ì •ìƒì ìœ¼ë¡œ ê°€ë¦¬í‚¤ë©° ìˆœíšŒ ì¢…ë£Œ.

ë¹„ì •ìƒ íë¦„:

* ë¦¬ìŠ¤íŠ¸ ì†ìƒìœ¼ë¡œ `pos`ê°€ `NULL`ì´ë‚˜ ìˆœí™˜ë˜ì§€ ì•ŠëŠ” ë…¸ë“œë¥¼ ê°€ë¦¬í‚´ â†’ ë£¨í”„ íƒˆì¶œ ë¶ˆê°€ â†’ ë¬´í•œ ë£¨í”„ ë°œìƒ.

---

**3. íƒì§€ ëª¨ë¸ ì…ë ¥ ì •ë³´ ë¶€ì¡±**

* `vectors.json`ì„ ë¶„ì„í•œ ê²°ê³¼, ìŠ¬ë¼ì´ìŠ¤ input\_token ì‹œí€€ìŠ¤ëŠ” ë‹¤ìŒê³¼ ê°™ì´ ë‹¨í¸ì ì„:

> ğŸ“„ vectors.json (idx: 0)
>
> ```plaintext
> <s>, memset, (, Var2, ,, 0, ,, sizeof, (, Var2, ), ), ;, ...
> ```

* **ë¬¸ì œì **: ë¦¬ìŠ¤íŠ¸ ìˆœíšŒ êµ¬ì¡°, í¬ì¸í„° ê°±ì‹  íë¦„, ë¬´í•œ ë°˜ë³µ ê°€ëŠ¥ì„±ì„ ëª¨ë¸ ì…ë ¥ì—ì„œ ì œê³µí•˜ì§€ ì•ŠìŒ.
* **ê²°ê³¼**: ëª¨ë¸ì´ ë¬´í•œ ë£¨í”„ ìœ„í—˜ì„ í•™ìŠµí•  ìˆ˜ ì—†ìŒ.

---

## ğŸ“ ê´€ë ¨ íŒŒì¼ ì†Œê°œ

| íŒŒì¼ëª…             | ì„¤ëª…             |
| :-------------- | :------------- |
| `before_fair.c` | ì·¨ì•½ ì½”ë“œ(ìˆ˜ì • ì „) í¬í•¨ |
| `after_fair.c`  | ê°œì„  ì½”ë“œ(ìˆ˜ì • í›„) í¬í•¨ |

---

## â—ï¸ ì·¨ì•½ ì½”ë“œ

ğŸ“„ **Source:** `rq->leaf_cfs_rq_list` ë¦¬ìŠ¤íŠ¸ (`before_fair.c:`)
ğŸ“„ **Sink:** `for_each_leaf_cfs_rq_safe` ë§¤í¬ë¡œ ê¸°ë°˜ ë¬´í•œ ìˆœíšŒ (`before_fair.c:356`)

```c
for_each_leaf_cfs_rq_safe(rq, cfs_rq, pos) {   // (Line 356) ë¦¬ìŠ¤íŠ¸ ìˆœíšŒ ë°˜ë³µë¬¸
    ...
}
```

### ğŸ“Œ ë°˜ë³µë¬¸ ê´€ë ¨ ë³€ìˆ˜ ì„¤ëª…

| ë³€ìˆ˜                     | ì„¤ëª…                                             |
| :--------------------- | :--------------------------------------------- |
| `rq->leaf_cfs_rq_list` | ìŠ¤ì¼€ì¤„ëŸ¬ ëŸ°íì— ë“±ë¡ëœ leaf runqueue ë¦¬ìŠ¤íŠ¸.                |
| `pos`                  | í˜„ì¬ ìˆœíšŒ ì¤‘ì¸ ë¦¬ìŠ¤íŠ¸ ë…¸ë“œ í¬ì¸í„°. ë‹¤ìŒ ì—”íŠ¸ë¦¬ë¥¼ ê°€ë¦¬ì¼œì•¼ ë£¨í”„ ì •ìƒ ì¢…ë£Œ ê°€ëŠ¥. |

---

### ğŸ“Œ ì •ìƒ íë¦„

* `pos`ê°€ ë¦¬ìŠ¤íŠ¸ ë‚´ ë‹¤ìŒ ì—”íŠ¸ë¦¬ë¥¼ ê°€ë¦¬í‚¤ë©° ìˆœíšŒ ì™„ë£Œ â†’ ë£¨í”„ ì¢…ë£Œ.

### ğŸ“Œ ë¹„ì •ìƒ íë¦„

* ë¦¬ìŠ¤íŠ¸ ì†ìƒ ì‹œ `pos`ê°€ ê°±ì‹ ë˜ì§€ ì•ŠìŒ â†’ ë£¨í”„ íƒˆì¶œ ì‹¤íŒ¨ â†’ ë¬´í•œ ë°˜ë³µ ë°œìƒ.

---

## âœ… ê°œì„  ì½”ë“œ

ğŸ“„ **íŒ¨ì¹˜ ìœ„ì¹˜:** `after_fair.c:356`

```c
#define for_each_leaf_cfs_rq(rq, cfs_rq) \
    list_for_each_entry_rcu(cfs_rq, &rq->leaf_cfs_rq_list, leaf_cfs_rq_list)
```

### ğŸ“Œ ê°œì„  ë°©ë²•

* ê¸°ì¡´ `for_each_leaf_cfs_rq_safe` ë§¤í¬ë¡œë¥¼,
  \*\*RCU ê¸°ë°˜ ì•ˆì „ ë¦¬ìŠ¤íŠ¸ ìˆœíšŒ ë§¤í¬ë¡œ(`list_for_each_entry_rcu`)\*\*ë¡œ ë³€ê²½.
* RCU(Read-Copy-Update) ê¸°ë²•ì„ í†µí•´ ë¦¬ìŠ¤íŠ¸ ë™ê¸°í™”, ì‚­ì œ/ë³€ê²½ ìƒí™©ì—ì„œë„ ì•ˆì „í•œ ìˆœíšŒ ë³´ì¥.
* í¬ì¸í„° ê°±ì‹ ì´ ë³´ì¥ë˜ë¯€ë¡œ ë¬´í•œ ë£¨í”„ ìœ„í—˜ ì œê±°.

---

## ğŸ§ª íƒì§€ ê²°ê³¼

*CVE ì„¤ëª…ì— ë‚˜ì˜¨ ì·¨ì•½í•œ í•¨ìˆ˜(Caller) ê¸°ë°˜ ìŠ¬ë¼ì´ìŠ¤ ê´€ë ¨ ë°ì´í„°ë§Œ ì¶”ì¶œ.*

| FileName       | Caller                          | Source |  Sink | idx | CWE-ID |    category    | criterion | line | label | token\_length | predict |
| :------------- | :------------------------------ | :----: | :---: | :-: | :----: | :------------: | :-------: | :--: | :---: | :-----------: | :-----: |
| before\_fair.c | init\_entity\_runnable\_average |  False | False |  0  |  CWE-  | CallExpression |   memset  |  703 |   -3  |       85      |    1    |
| before\_fair.c | update\_numa\_stats             |  False | False |  1  |  CWE-  | CallExpression |   memset  | 1476 |   -3  |       95      |    1    |
| before\_fair.c | update\_task\_scan\_period      |  False | False |  2  |  CWE-  | CallExpression |   memset  | 1978 |   -3  |      409      |    0    |
| before\_fair.c | task\_numa\_fault               |  False | False |  3  |  CWE-  | CallExpression |   memset  | 2375 |   -3  |      419      |    0    |
| before\_fair.c | update\_sg\_lb\_stats           |  False | False |  4  |  CWE-  | CallExpression |   memset  | 8172 |   -3  |      390      |    0    |



