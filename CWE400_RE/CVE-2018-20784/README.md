# ğŸ“ CVE-2018-20784

## ğŸ” ì·¨ì•½ì  ê°œìš”

ğŸ”— [ì»¤ë°‹ ë§í¬](https://github.com/php/php-src/commit/0f8cf3b8497dc45c010c44ed9e96518e11e19fc3) | ğŸ”— [CVE ë§í¬](https://www.cvedetails.com/cve/CVE-2018-20784/) | ğŸ”— [CWE ë§í¬ (CWE-400)](https://cwe.mitre.org/data/definitions/400.html)

Linux ì»¤ë„ Completely Fair Scheduler(CFS)ì˜ `update_blocked_averages()` í•¨ìˆ˜ ë‚´ ë¦¬ìŠ¤íŠ¸ ìˆœíšŒ ë£¨í”„ì—ì„œ,
ë¹„ì •ìƒì ì¸ ë¦¬ìŠ¤íŠ¸ ìƒíƒœ(`rq->leaf_cfs_rq_list`)ë¡œ ì¸í•´ ë£¨í”„ê°€ ì¢…ë£Œë˜ì§€ ì•Šê³  **ë¬´í•œ ë£¨í”„**ì— ë¹ ì§€ëŠ” **ì„œë¹„ìŠ¤ ê±°ë¶€(DoS)** ì·¨ì•½ì ì…ë‹ˆë‹¤.

* **ì·¨ì•½ì  ì¢…ë¥˜:** \[CWE-400] Uncontrolled Resource Consumption
* **ì·¨ì•½ ì¡°ê±´:** ë¦¬ìŠ¤íŠ¸ ìˆœíšŒ ì¤‘ ì†ìƒëœ ì—”íŠ¸ë¦¬ ì ‘ê·¼, í¬ì¸í„° ìœ ì§€ ì‹¤íŒ¨
* **Sink:** `for_each_leaf_cfs_rq_safe()` ë§¤í¬ë¡œ ë°˜ë³µë¬¸ ë‚´ ë¬´í•œ ìˆœíšŒ

---

## íƒì§€ ê²°ê³¼ ìš”ì•½

CVE ì„¤ëª…ì„ ê¸°ë°˜ìœ¼ë¡œ `update_blocked_averages()` í•¨ìˆ˜ ì¤‘ì‹¬ìœ¼ë¡œ ìŠ¬ë¼ì´ìŠ¤ë¥¼ ìˆ˜ì§‘í•œ ê²°ê³¼:

| ì´ ìŠ¬ë¼ì´ìŠ¤ ìˆ˜ | ì·¨ì•½ìœ¼ë¡œ íƒì§€ | ì •ìƒìœ¼ë¡œ íƒì§€ |
| :------: | :-----: | :-----: |
|    5ê°œ    |    2ê°œ   |    3ê°œ   |

* ê·¸ëŸ¬ë‚˜ ì·¨ì•½ í•¨ìˆ˜ì¸ `update_blocked_averages()` í•¨ìˆ˜ì— ëŒ€í•œ ìŠ¬ë¼ì´ìŠ¤ëŠ” ìƒì„±ë˜ì§€ ì•Šì•˜ìœ¼ë©°,
* ëª¨ë‘ ë‹¤ë¥¸ í•¨ìˆ˜(`memset()` í˜¸ì¶œ)ì—ì„œ ìƒì„±ëœ ìŠ¬ë¼ì´ìŠ¤ì…ë‹ˆë‹¤.

| FileName | Caller                          | Source |  Sink | idx | CWE-ID |    category    | criterion | line | label | token\_length | predict |
| :------- | :------------------------------ | :----: | :---: | :-: | :----: | :------------: | :-------: | :--: | :---: | :-----------: | :-----: |
| before.c | init\_entity\_runnable\_average |  False | False |  0  |  CWE-  | CallExpression |   memset  |  703 |   -3  |       85      |    1    |
| before.c | update\_numa\_stats             |  False | False |  1  |  CWE-  | CallExpression |   memset  | 1476 |   -3  |       95      |    1    |
| before.c | update\_task\_scan\_period      |  False | False |  2  |  CWE-  | CallExpression |   memseí•­
3. **ë²¡í„° ë‹¨ì ˆ**

   ìŠ¬ë¼ì´ìŠ¤ì— í¬í•¨ëœ ì½”ë“œê°€ ë²¡í„°ë¡œ ë³€í™˜ë˜ëŠ” ê³¼ì •ì—ì„œ ë¦¬ìŠ¤íŠ¸ ìˆœíšŒ, í¬ì¸í„° ì—°ì‚° ë“±ì˜ ë³µì¡í•œ ì»¤ë„ ë‚´ë¶€ êµ¬ì¡°ê°€ ë°˜ì˜ë˜ì§€ ì•Šì•˜ê³ ,
   ë²¡í„° ê¸¸ì´ ì œí•œìœ¼ë¡œ ì¸í•´ ë°˜ë³µë¬¸ íë¦„ ì „ì²´ë¥¼ í•™ìŠµ ë°ì´í„°ë¡œ ì „ë‹¬í•  ìˆ˜ ì—†ì—ˆìŠµë‹ˆë‹¤.

---
## íƒì§€ ê²°ê³¼ ìš”ì•½
---
## ğŸ“ ê´€ë ¨ íŒŒì¼ ì†Œê°œ

| íŒŒì¼ëª…             | ì„¤ëª…             |
| :-------------- | :------------- |
| `before_fair.c` | ì·¨ì•½ ì½”ë“œ(ìˆ˜ì • ì „) í¬í•¨ |
| `after_fair.c`  | ê°œì„  ì½”ë“œ(ìˆ˜ì • í›„) í¬í•¨ |

---

## â—ï¸ ì·¨ì•½ ì½”ë“œ

```c
for_each_leaf_cfs_rq_safe(rq, cfs_rq, pos) {
    ...
}
```

**ë¬¸ì œì :**

* ë¦¬ìŠ¤íŠ¸ ìˆœíšŒ êµ¬ì¡°(`rq->leaf_cfs_rq_list`)ì˜ ë¬´ê²°ì„±ì´ ì†ìƒëœ ê²½ìš°, ë‹¤ìŒ ì—”íŠ¸ë¦¬ë¡œì˜ ì´ë™ì´ ì •ìƒì ìœ¼ë¡œ ì´ë£¨ì–´ì§€ì§€ ì•ŠìŒ
* í¬ì¸í„°(`pos`)ê°€ ê°±ì‹ ë˜ì§€ ì•Šì•„ ë£¨í”„ ì¢…ë£Œ ì¡°ê±´ì´ ì¶©ì¡±ë˜ì§€ ì•Šê³  ë¬´í•œ ë£¨í”„ì— ë¹ ì§
* ê²°ê³¼ì ìœ¼ë¡œ, ê³ ë¶€í•˜ ìƒí™©ì—ì„œ ì‹œìŠ¤í…œ ì‘ë‹µ ë¶ˆê°€, ì»¤ë„ lockup ë“±ì˜ ì‹¬ê°í•œ ì¥ì•  ìœ ë°œ

---

## âœ… ê°œì„  ì½”ë“œ

**íŒ¨ì¹˜ ìœ„ì¹˜:** `after_fair.c:1152`

```c
#define for_each_leaf_cfs_rq(rq, cfs_rq) \
    list_for_each_entry_rcu(cfs_rq, &rq->leaf_cfs_rq_list, leaf_cfs_rq_list)
```

**ê°œì„  ë°©ë²•:**

* `list_for_each_entry_rcu()`ë¥¼ í†µí•´ **RCU(Read-Copy-Update)** ê¸°ë°˜ ì•ˆì „ ë¦¬ìŠ¤íŠ¸ ìˆœíšŒë¥¼ ì ìš©
* RCU ë³´í˜¸ í•˜ì— ë¦¬ìŠ¤íŠ¸ ë³€í˜• ì‹œì—ë„ ë…¸ë“œ ì‚­ì œ ë° ì ‘ê·¼ ì¶©ëŒ ë°©ì§€
* ë£¨í”„ íƒˆì¶œ ë³´ì¥ì„ í†µí•´ ë¬´í•œ ë£¨í”„ ë° ì»¤ë„ hang ê°€ëŠ¥ì„± ì œê±°

---

## ğŸ§ª íƒì§€ ê²°ê³¼ (ìŠ¬ë¼ì´ìŠ¤ ìƒì„¸)

*CVE ì„¤ëª…ì— ë‚˜ì˜¨ ì·¨ì•½í•œ í•¨ìˆ˜(`Caller`)ì— ëŒ€í•œ ìŠ¬ë¼ì´ìŠ¤ ê´€ë ¨ ë°ì´í„°ë§Œ ì¶”ì¶œ.*

| FileName | Caller                          | Source |  Sink | idx | CWE-ID |    category    | criterion | line | label | token\_length | predict |
| :------- | :------------------------------ | :----: | :---: | :-: | :----: | :------------: | :-------: | :--: | :---: | :-----------: | :-----: |
| before.c | init\_entity\_runnable\_average |  False | False |  0  |  CWE-  | CallExpression |   memset  |  703 |   -3  |       85      |    1    |
| before.c | update\_numa\_stats             |  False | False |  1  |  CWE-  | CallExpression |   memset  | 1476 |   -3  |       95      |    1    |
| before.c | update\_task\_scan\_period      |  False | False |  2  |  CWE-  | CallExpression |   memset  | 1978 |   -3  |      409      |    0    |
| before.c | task\_numa\_fault               |  False | False |  3  |  CWE-  | CallExpression |   memset  | 2375 |   -3  |      419      |    0    |
| before.c | update\_sg\_lb\_stats           |  False | False |  4  |  CWE-  | CallExpression |   memset  | 8172 |   -3  |      390      |    0    |


