# ğŸ“ CVE-2017-11142

## ğŸ” ì·¨ì•½ì  ê°œìš”
**ğŸ”— [ì»¤ë°‹ ë§í¬](https://github.com/php/php-src/commit/2b0f239b211c7544ebc7a4cd2c977a5b7a11ed8a)** | **ğŸ”— [CVE ë§í¬](https://www.cvedetails.com/cve/CVE-2017-11142/)** | **[ì·¨ì•½ì  ì¢…ë¥˜: [CWE-400] Resource Exhaustion](https://cwe.mitre.org/data/definitions/400.html)** 

> PHPì˜ POST ë³€ìˆ˜ ì²˜ë¦¬ ê³¼ì •ì—ì„œ ë°œìƒí•˜ëŠ” ë¦¬ì†ŒìŠ¤ ì†Œì§„ ì·¨ì•½ì ì…ë‹ˆë‹¤. `add_post_var()` í•¨ìˆ˜ì—ì„œ ë©”ëª¨ë¦¬ ê²€ìƒ‰ ì‹œ ì´ë¯¸ ê²€ì‚¬í•œ ì˜ì—­ì„ ë‹¤ì‹œ ê²€ì‚¬í•˜ì§€ ì•Šë„ë¡ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.

* **ì·¨ì•½ ì¡°ê±´**: POST ë°ì´í„° ì²˜ë¦¬ ì‹œ ë™ì¼í•œ ë©”ëª¨ë¦¬ ì˜ì—­ì„ ë°˜ë³µì ìœ¼ë¡œ ê²€ì‚¬
* **Sink**: `memchr()` í•¨ìˆ˜ë¥¼ í†µí•œ ë©”ëª¨ë¦¬ ê²€ìƒ‰

### ì·¨ì•½ì  ë°œìƒ ì‹œë‚˜ë¦¬ì˜¤
```
POST ë°ì´í„°: "name=value&age=20&city=seoul"

ì²« ë²ˆì§¸ ê²€ì‚¬: "name=value&age=20&city=seoul"
               ^
ë‘ ë²ˆì§¸ ê²€ì‚¬: "name=value&age=20&city=seoul"
                      ^
ì„¸ ë²ˆì§¸ ê²€ì‚¬: "name=value&age=20&city=seoul"
                             ^
```
- ë§¤ ê²€ì‚¬ë§ˆë‹¤ ì²˜ìŒë¶€í„° ëê¹Œì§€ ë‹¤ì‹œ ê²€ì‚¬
- ì´ë¯¸ ê²€ì‚¬í•œ ë¶€ë¶„ì„ ë‹¤ì‹œ ê²€ì‚¬í•˜ëŠ” ë¹„íš¨ìœ¨ ë°œìƒ
- ë°ì´í„°ê°€ í´ ê²½ìš° ì„±ëŠ¥ ì €í•˜ì™€ ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰ ì¦ê°€

## íƒì§€ ê²°ê³¼ ìš”ì•½
cve ì„¤ëª…ì— ë‚˜ì˜¨ ì·¨ì•½í•œ í•¨ìˆ˜(Caller)ì— ëŒ€í•œ ìŠ¬ë¼ì´ìŠ¤ë§Œ ê³ ë ¤í–ˆì„ ë•Œ,

| ì´ ìŠ¬ë¼ì´ìŠ¤ ìˆ˜ |  ì·¨ì•½ìœ¼ë¡œ íƒì§€ | ì •ìƒìœ¼ë¡œ íƒì§€ |
| --------  | -- | -- |
| 14ê°œ       | 0ê°œ | 14ê°œ |

#### SARDëŠ” ì˜ íƒì§€í•˜ëŠ”ë° ì´ CVEëŠ” íƒì§€ ëª»í–ˆë˜ ì´ìœ 

AI ëª¨ë¸ì€ CWE-400ì˜ ê²½ìš° ë©”ëª¨ë¦¬ í• ë‹¹/í•´ì œ í•¨ìˆ˜ê°€ ìŠ¬ë¼ì´ìŠ¤ì— ì¡´ì¬í•´ì•¼ ì·¨ì•½ìœ¼ë¡œ íŒë‹¨í•˜ëŠ”ë°, ì´ ì·¨ì•½ì ì˜ ê²½ìš° `memchr()` í•¨ìˆ˜ë§Œ í¬í•¨ë˜ì–´ ìˆì–´ ì •ìƒìœ¼ë¡œ íŒë‹¨ëœ ê²ƒìœ¼ë¡œ ë³´ì„.

---

### âš ï¸ íƒì§€ ê²°ê³¼ ë¬¸ì œì 

í˜„ì¬ íƒì§€ ê²°ê³¼ì—ì„œ ëª¨ë“  ìŠ¬ë¼ì´ìŠ¤ê°€ ì •ìƒ(ë¼ë²¨ 0)ìœ¼ë¡œ íŒì •ë˜ì—ˆìœ¼ë‚˜, ì´ëŠ” ë‹¤ìŒê³¼ ê°™ì€ ê¸°ìˆ ì  í•œê³„ë¡œ ì¸í•œ ì˜¤íƒìœ¼ë¡œ íŒë‹¨ë©ë‹ˆë‹¤:

1. **ì •ì  ë¶„ì„ì˜ í•œê³„**
   - ëª¨ë“  ìŠ¬ë¼ì´ìŠ¤ê°€ ì •ìƒìœ¼ë¡œ íƒì§€ë¨
   - ì •ì  ë¶„ì„ ë„êµ¬ê°€ ëŸ°íƒ€ì„ ì„±ëŠ¥ ë¬¸ì œë¥¼ íƒì§€í•˜ì§€ ëª»í•¨
   - CWE-400ê³¼ ê°™ì€ ë¦¬ì†ŒìŠ¤ ì†Œì§„ ì·¨ì•½ì ì€ ì •ì  ë¶„ì„ìœ¼ë¡œëŠ” íƒì§€ê°€ ì–´ë ¤ì›€
   - ğŸ“„ ê·¼ê±°: `test_output.csv`ì˜ predict ê°’ì´ ëª¨ë‘ 0ìœ¼ë¡œ í‘œì‹œë¨

2. **ì·¨ì•½ì ì˜ íŠ¹ì„±**
   - ì·¨ì•½ì ì´ ì—¬ëŸ¬ í•¨ìˆ˜ì— ê±¸ì³ ì¡´ì¬
   - ë©”ëª¨ë¦¬ ê²€ìƒ‰ì˜ ë¹„íš¨ìœ¨ì„±ì´ ì£¼ìš” ë¬¸ì œ
   - ì´ëŸ¬í•œ ì„±ëŠ¥ ê´€ë ¨ ë¬¸ì œëŠ” ì •ì  ë¶„ì„ìœ¼ë¡œëŠ” íŒŒì•…ì´ ì–´ë ¤ì›€
   - ğŸ“„ ê·¼ê±°: `before_php_variables.c`ì˜ ì—¬ëŸ¬ í•¨ìˆ˜ì—ì„œ ë©”ëª¨ë¦¬ ê²€ìƒ‰ ìˆ˜í–‰

### Sourceì™€ Sink ë¶„ì„
- **Source í•¨ìˆ˜ ë¶„ë¥˜**:
  - `add_post_var`: POST ë°ì´í„° ì²˜ë¦¬ í•¨ìˆ˜ (2ê°œ ìŠ¬ë¼ì´ìŠ¤)
  - `add_post_vars`: POST ë³€ìˆ˜ ì²˜ë¦¬ í•¨ìˆ˜ (1ê°œ ìŠ¬ë¼ì´ìŠ¤)
  - `php_auto_globals_create_*`: ìë™ ì „ì—­ ë³€ìˆ˜ ìƒì„± í•¨ìˆ˜ë“¤ (10ê°œ ìŠ¬ë¼ì´ìŠ¤)
  - `check_http_proxy`: HTTP í”„ë¡ì‹œ ê²€ì‚¬ í•¨ìˆ˜ (1ê°œ ìŠ¬ë¼ì´ìŠ¤)

- **Sink í•¨ìˆ˜ ë¶„ë¥˜**:
  - `memchr`: ë©”ëª¨ë¦¬ ê²€ìƒ‰ í•¨ìˆ˜ (2ê°œ ìŠ¬ë¼ì´ìŠ¤)
  - `memmove`: ë©”ëª¨ë¦¬ ì´ë™ í•¨ìˆ˜ (1ê°œ ìŠ¬ë¼ì´ìŠ¤)
  - `strchr`: ë¬¸ìì—´ ê²€ìƒ‰ í•¨ìˆ˜ (10ê°œ ìŠ¬ë¼ì´ìŠ¤)
  - `getenv`: í™˜ê²½ ë³€ìˆ˜ ê²€ìƒ‰ í•¨ìˆ˜ (1ê°œ ìŠ¬ë¼ì´ìŠ¤)

---

## ì·¨ì•½ì  ì„¸ë¶€ ì‚¬í•­

### ğŸ“ ê´€ë ¨ íŒŒì¼ ì†Œê°œ
| íŒŒì¼ëª… | ì„¤ëª… |
| ------ | ---- |
| `CVE-2017-11142.diff` | íŒ¨ì¹˜ ì •ë³´ì™€ ì·¨ì•½ì  ê¸°ë³¸ ì •ë³´ |
| `before_php_variables.c` | ì·¨ì•½í•œ ì†ŒìŠ¤ ì½”ë“œ |
| `after_php_variables.c` | íŒ¨ì¹˜ëœ ì†ŒìŠ¤ ì½”ë“œ |
| `test_output.csv` | ìŠ¬ë¼ì´ìŠ¤ ë¶„ì„ ê²°ê³¼ì™€ í†µê³„ |
| `slicer_result.json` | ìƒì„¸ ìŠ¬ë¼ì´ìŠ¤ ì •ë³´ |
| `slicer_result.symbolized.json` | ì‹¬ë³¼í™”ëœ ìŠ¬ë¼ì´ìŠ¤ ì •ë³´ |
| `vectors.json` | í…ŒìŠ¤íŠ¸ ë²¡í„°ì™€ ì·¨ì•½ì  íŠ¸ë¦¬ê±° ì¡°ê±´ |

---

### â—ï¸ ì·¨ì•½ ì½”ë“œ

**ë¬¸ì œì **:
`add_post_var()` í•¨ìˆ˜ì—ì„œ POST ë°ì´í„°ë¥¼ ì²˜ë¦¬í•  ë•Œ, ì´ë¯¸ ê²€ì‚¬í•œ ë©”ëª¨ë¦¬ ì˜ì—­ì„ ë‹¤ì‹œ ê²€ì‚¬í•˜ëŠ” ë¬¸ì œê°€ ìˆì—ˆìŠµë‹ˆë‹¤. ì´ë¡œ ì¸í•´ ë™ì¼í•œ ë©”ëª¨ë¦¬ ì˜ì—­ì„ ë°˜ë³µì ìœ¼ë¡œ ê²€ì‚¬í•˜ë©´ì„œ ë¦¬ì†ŒìŠ¤ê°€ ì†Œì§„ë  ìˆ˜ ìˆì—ˆìŠµë‹ˆë‹¤.

#### ì·¨ì•½í•œ êµ¬ì¡°ì²´ ì •ì˜ (`before_php_variables.c:234`)
```c
typedef struct post_var_data {
    smart_str str;    // POST ë°ì´í„°ë¥¼ ì €ì¥í•˜ëŠ” ë¬¸ìì—´ ë²„í¼
    char *ptr;        // í˜„ì¬ ì²˜ë¦¬ ì¤‘ì¸ ìœ„ì¹˜
    char *end;        // ë°ì´í„°ì˜ ë ìœ„ì¹˜
    uint64_t cnt;     // ì²˜ë¦¬ëœ ë³€ìˆ˜ ìˆ˜
} post_var_data_t;
```

#### Sink: `before_php_variables.c:253`
```c
// POST ë°ì´í„°ì—ì„œ '&' ë¬¸ìë¥¼ ì°¾ì•„ ë‹¤ìŒ ë³€ìˆ˜ì˜ ì‹œì‘ ìœ„ì¹˜ë¥¼ ì°¾ìŒ
// ë¬¸ì œì : ë§¤ë²ˆ ì²˜ìŒë¶€í„° ëê¹Œì§€ ê²€ì‚¬í•˜ì—¬ ë¹„íš¨ìœ¨ì 
vsep = memchr(var->ptr, '&', var->end - var->ptr);

// ë°ì´í„° ì²˜ë¦¬ í›„ ë‹¤ìŒ ê²€ì‚¬ë¥¼ ìœ„í•´ í¬ì¸í„° ì´ë™
var->ptr = vsep + (vsep != var->end);
```

---

### âœ… ê°œì„  ì½”ë“œ

**íŒ¨ì¹˜ëœ êµ¬ì¡°ì²´ ì •ì˜** (`after_php_variables.c:234`)
```c
typedef struct post_var_data {
    smart_str str;    // POST ë°ì´í„°ë¥¼ ì €ì¥í•˜ëŠ” ë¬¸ìì—´ ë²„í¼
    char *ptr;        // í˜„ì¬ ì²˜ë¦¬ ì¤‘ì¸ ìœ„ì¹˜
    char *end;        // ë°ì´í„°ì˜ ë ìœ„ì¹˜
    uint64_t cnt;     // ì²˜ë¦¬ëœ ë³€ìˆ˜ ìˆ˜
    size_t already_scanned;  // ì´ë¯¸ ê²€ì‚¬í•œ ë°”ì´íŠ¸ ìˆ˜ë¥¼ ì¶”ì 
} post_var_data_t;
```

**íŒ¨ì¹˜ëœ í•¨ìˆ˜** (`after_php_variables.c:253`)
```c
static zend_bool add_post_var(zval *arr, post_var_data_t *var, zend_bool eof TSRMLS_DC)
{
    // start ë³€ìˆ˜ ì¶”ê°€
    char *start, *ksep, *vsep, *val;
    size_t klen, vlen;
    /* FIXME: string-size_t */
    unsigned int new_vlen;

    if (var->ptr >= var->end) {
        return 0;
    }

    // ì´ë¯¸ ê²€ì‚¬í•œ ìœ„ì¹˜ ì´í›„ë¶€í„° ê²€ì‚¬ ì‹œì‘
    start = var->ptr + var->already_scanned;
    // ê²€ìƒ‰ ë²”ìœ„ë¥¼ ìµœì í™”í•˜ì—¬ ë©”ëª¨ë¦¬ ê²€ìƒ‰ ìˆ˜í–‰
    vsep = memchr(start, '&', var->end - start);
    if (!vsep) {
        if (!eof) {
            // EOFê°€ ì•„ë‹Œ ê²½ìš°, í˜„ì¬ê¹Œì§€ ê²€ì‚¬í•œ ìœ„ì¹˜ ì €ì¥
            var->already_scanned = var->end - var->ptr;
            return 0;
        } else {
            vsep = var->end;
        }
    }

    // ... (ì¤‘ê°„ ì½”ë“œ ìƒëµ) ...

    // ë°ì´í„° ì²˜ë¦¬ í›„ ë‹¤ìŒ ê²€ì‚¬ë¥¼ ìœ„í•´ í¬ì¸í„° ì´ë™
    var->ptr = vsep + (vsep != var->end);
    // ë‹¤ìŒ ê²€ì‚¬ë¥¼ ìœ„í•´ already_scanned ì´ˆê¸°í™”
    var->already_scanned = 0;
    return 1;
}

// add_post_vars í•¨ìˆ˜ì˜ ë©”ëª¨ë¦¬ ì´ë™ ìµœì í™”
static inline int add_post_vars(zval *arr, post_var_data_t *vars, zend_bool eof TSRMLS_DC)
{
    // ... (ì¤‘ê°„ ì½”ë“œ ìƒëµ) ...

    // ë¶ˆí•„ìš”í•œ ë©”ëª¨ë¦¬ ì´ë™ ë°©ì§€
    if (!eof && vars->str.c != vars->ptr) {
        memmove(vars->str.c, vars->ptr, vars->str.len = vars->end - vars->ptr);
    }
    return SUCCESS;
}
```

---

### íƒì§€ ê²°ê³¼
\* ì·¨ì•½í•œ í•¨ìˆ˜(Caller)ì— ëŒ€í•œ ìŠ¬ë¼ì´ìŠ¤ ê´€ë ¨ ë°ì´í„°ë§Œ ì¶”ì¶œ

|FileName |Caller |Source|Sink |idx|CWE-ID|category |criterion|line|label|token_length|predict|
|---------|-------|------|-----|---|------|---------|---------|----|-----|------------|-------|
|before_php_variables.c|add_post_var|False|False|0|CWE-|CallExpression|memchr|253|-3|290|0|
|before_php_variables.c|add_post_var|False|False|1|CWE-|CallExpression|memchr|262|-3|290|0|
|before_php_variables.c|add_post_vars|False|False|2|CWE-|CallExpression|memmove|308|-3|152|0|
|before_php_variables.c|php_auto_globals_create_get|False|False|3|CWE-|CallExpression|strchr|720|-3|0|0|
|before_php_variables.c|php_auto_globals_create_get|False|False|4|CWE-|CallExpression|strchr|720|-3|0|0|
|before_php_variables.c|php_auto_globals_create_post|False|False|5|CWE-|CallExpression|strchr|743|-3|0|0|
|before_php_variables.c|php_auto_globals_create_post|False|False|6|CWE-|CallExpression|strchr|743|-3|0|0|
|before_php_variables.c|php_auto_globals_create_cookie|False|False|7|CWE-|CallExpression|strchr|769|-3|0|0|
|before_php_variables.c|php_auto_globals_create_cookie|False|False|8|CWE-|CallExpression|strchr|769|-3|0|0|
|before_php_variables.c|check_http_proxy|False|False|9|CWE-|CallExpression|getenv|811|-3|63|0|
|before_php_variables.c|php_auto_globals_create_server|False|False|10|CWE-|CallExpression|strchr|826|-3|0|0|
|before_php_variables.c|php_auto_globals_create_server|False|False|11|CWE-|CallExpression|strchr|826|-3|0|0|
|before_php_variables.c|php_auto_globals_create_env|False|False|12|CWE-|CallExpression|strchr|874|-3|0|0|
|before_php_variables.c|php_auto_globals_create_env|False|False|13|CWE-|CallExpression|strchr|874|-3|0|0|