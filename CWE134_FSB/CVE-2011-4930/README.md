# 📁 CVE-2011-4930

## 🔍 취약점 개요

**🔗 [커밋 링크](https://github.com/htcondor/htcondor/commit/5e5571d1a431eb3c61977b6dd6ec90186ef79867)** | **🔗 [CVE 링크](https://www.cvedetails.com/cve/CVE-2011-4930)**  | **🔗 [CWE 링크](https://cwe.mitre.org/data/definitions/134.html)**  

> HTCondor 7.2.0 \~ 7.6.4 및 일부 7.7.x 버전의 `credd.cpp` 파일에서 `sprintf`에 사용자 입력이 포맷 문자열로 직접 사용되어 발생하는 \*\*형식 문자열 취약점(CWE-134)\*\*입니다. 공격자는 서비스 거부를 유발하거나 포맷 문자열 조작을 통해 메모리 접근이 가능합니다.

* **Source**: pColon 포인터가 가리키는 버퍼(credential 문자열)
* **취약 조건**: `:` 구분자를 포함한 credential 입력이 들어올 경우, `:` 이후 문자열이 포맷 문자열로 직접 사용됨
* **Sink**: `sprintf(..., pColon, ...)` – 포맷 문자열이 해석되는 함수

---

## 탐지 결과 요약

| 총 슬라이스 수 | 취약으로 탐지 | 정상으로 탐지 |
|----------------|----------------|----------------|
| 0개           | 0개            | 0개           |

CVE-2011-4930 취약점 패치에 언급된 코드가 포함된 슬라이스를 만들지 못함. 그 결과 Ksign 모델에서 이 CVE를 탐지할 수 없음.

위 슬라이스를 만들지 못한 원인은 \* Sink(`sprintf` 함수)를 Ksign 슬라이서에서 고려하지 않았기 때문임.

이 CVE 취약점을 유발하는 코드는 아래와 같다.

```
if (!socket->code(name)) {
    dprintf (D_ALWAYS, "Error receiving credential name\n"); 
    goto EXIT;
  }

  user = socket->getFullyQualifiedUser();
  dprintf (D_ALWAYS, "Authenticated as %s\n", user);

  if (strchr (name, ':')) {
    // The name is of the form user:name
    // This better be a super-user!
    // TODO: Check super-user's list

    // Owner is the first part
    owner = strdup (name);
    char * pColon = strchr (owner, ':');
    *pColon = '\0';
    
    // Name is the second part
    sprintf (name, (char*)(pColon+sizeof(char)));
```

이 코드에서 Ksign 슬라이서 도구가 추출했어야 하는 슬라이스를 직접 작성해보면 다음과 같다.

 {
    "FileName": "credd_before.cpp",
    "Caller": "SaveCredentialList",
    "Source": false,
    "Sink": false,
    "idx": 29,
    "CWE-ID": "CWE-",
    "category": "CallExpression",
    "criterion": "fclose",
    "line": 547,
    "label": -3,
    "slices": [
      "if (!socket->code(name)) {\n",
         "if (strchr (name, ':')) {\n",
         "owner = strdup (name);\n",
         "char * pColon = strchr (owner, ':');\n",
         "*pColon = '\\0';\n",
         "sprintf (name, (char*)(pColon+sizeof(char)));\n"
    ]
  }

   이 슬라이스를 수동으로 Ksign 모델에 적용해서 결과를 탐지해보았더니 ..
---

#### SARD는 잘 탐지하는데 이 CVE는 탐지 못했던 이유

1. **부적절한 criterion**
   * 이 취약점의 경우 criterion으로 `sprintf`가 잡히지 않아 정상으로 판단된 것으로 보임.

2. **CPG 생성 단계에서 함수 호출 누락**
   * `sprintf`가 `l_func`에 존재하는 데도 criterion으로 잡히지 않았음
   * `before_credd.cpp`를 기반으로 생성된 CPG 내 `nodes.csv`에서 `sprintf` 호출 노드 자체가 존재하지 않음(근거: `credd_nodes.csv`)

---

## 취약점 세부 사항

### ❗️취약 코드

#### Sink: `before_credd.cpp:266`

```c
sprintf(name, (char*)(pColon + sizeof(char)));
```

**문제점**:
* 사용자 입력 문자열에서 `:` 이후 부분을 `sprint`의 두 번째 인자인 포맷 문자열로 그대로 전달
* 사용자 입력에에 `%s`, `%x` 등이 포함될 경우 메모리 노출 또는 비정상 동작 유발 가능

### ✅ 개선 코드

**패치 위치**: `after_credd.cpp:266`

```c
sprintf(name, "%s", (char*)(pColon + sizeof(char)));
```

**개선 방법**:

* 두 번째 인자인 포맷 문자열을 고정된 `"%s"`로 설정하여 외부 입력이 포맷으로 해석되지 않도록 처리
* 외부 입력(`sprintf`의 세 번째 인자)은 포맷 문자열(`sprintf`의 두 번째 인자) 인자로만 사용하여 CWE-134 공격 가능성 제거

---

## 탐지 결과
\* cve 설명에 나온 취약한 함수(Caller)에 대한 슬라이스 관련 데이터만 추출
* 없음