# ğŸ“ CVE-2011-4930

## ğŸ” ì·¨ì•½ì  ê°œìš”

**ğŸ”— [ì»¤ë°‹ ë§í¬](https://github.com/htcondor/htcondor/commit/5e5571d1a431eb3c61977b6dd6ec90186ef79867)** | **ğŸ”— [CVE ë§í¬](https://www.cvedetails.com/cve/CVE-2011-4930)** | **ğŸ”— [CWE ë§í¬](https://cwe.mitre.org/data/definitions/134.html)**  

> HTCondor 7.2.0 \~ 7.6.4 ë° ì¼ë¶€ 7.7.x ë²„ì „ì˜ `preen.cpp` íŒŒì¼ì—ì„œ `fprintf`, `dprintf`ì— ì‚¬ìš©ì ì…ë ¥ì´ í¬ë§· ë¬¸ìì—´ë¡œ ì§ì ‘ ì‚¬ìš©ë˜ì–´ ë°œìƒí•˜ëŠ” \*\*í˜•ì‹ ë¬¸ìì—´ ì·¨ì•½ì (CWE-134)\*\*ì…ë‹ˆë‹¤. ê³µê²©ìëŠ” ì„œë¹„ìŠ¤ ê±°ë¶€ë¥¼ ìœ ë°œí•˜ê±°ë‚˜ í¬ë§· ë¬¸ìì—´ ì¡°ì‘ì„ í†µí•´ ë©”ëª¨ë¦¬ ì ‘ê·¼ì´ ê°€ëŠ¥í•©ë‹ˆë‹¤.

**ì·¨ì•½ì  ì¢…ë¥˜**: \[[CWE-134](https://cwe.mitre.org/data/definitions/134.html)] Use of Externally-Controlled Format String

* **Source**: Condor ì‹œìŠ¤í…œì´ ìŠ¤ìº”í•œ ë””ë ‰í„°ë¦¬ ë‚´ë¶€ì˜ **íŒŒì¼ ê²½ë¡œ ë¬¸ìì—´(`str`)**ì´ í¬í•¨ëœ `szTmp`  
  â†’ ì´ ë¬¸ìì—´ì€ `bad_file()` í•¨ìˆ˜ ë‚´ì—ì„œ ë””ë ‰í„°ë¦¬ ê²½ë¡œì™€ íŒŒì¼ëª…ì„ ê²°í•©í•´ ìƒì„±ë˜ë©°,  
     ê³µê²©ìê°€ ë””ìŠ¤í¬ ìƒì— í¬ë§· ë¬¸ìì—´ì´ í¬í•¨ëœ íŒŒì¼ëª…ì„ ë§Œë“¤ì–´ ë‘˜ ê²½ìš°, í•´ë‹¹ ê²½ë¡œ ë¬¸ìì—´ ì „ì²´ê°€ `fprintf()` ë° `dprintf()`ì— í¬ë§· ë¬¸ìì—´ë¡œ í•´ì„ë  ìˆ˜ ìˆìŒ
     
* **ì·¨ì•½ ì¡°ê±´**: `str` ê°’ì— `%s`, `%x`, `%n` ë“±ì˜ í¬ë§· ë¬¸ìì—´ì´ í¬í•¨ë  ê²½ìš°  
  â†’ í•´ë‹¹ ë¬¸ìì—´ì´ `szTmp.sprintf()`ë¥¼ í†µí•´ í¬ë§· ë¬¸ìì—´ë¡œ ë³€í™˜ë˜ê³ , ì´í›„ `fprintf()` ë° `dprintf()`ì— **í˜•ì‹ ì§€ì • ì—†ì´ ê·¸ëŒ€ë¡œ ì „ë‹¬ë¨**

* **Sink**:  
  - `fprintf(mailer, szTmp.Value());`  
  - `dprintf(D_ALWAYS, szTmp.Value());`  
  ì´ ë‘ í•¨ìˆ˜ëŠ” í¬ë§· ë¬¸ìì—´ì„ ê¸°ëŒ€í•˜ëŠ”ë°, ì‚¬ìš©ìê°€ ì¡°ì‘í•œ ë¬¸ìì—´ì´ ê·¸ëŒ€ë¡œ í¬ë§· ë¬¸ìì—´ë¡œ í•´ì„ë˜ì–´ **í¬ë§· ìŠ¤íŠ¸ë§ ì¸ì ì…˜ì´ ë°œìƒ**


---

## ğŸ“Š íƒì§€ ê²°ê³¼ ìš”ì•½

| ì´ ìŠ¬ë¼ì´ìŠ¤ ìˆ˜ | ì·¨ì•½ìœ¼ë¡œ íƒì§€ | ì •ìƒìœ¼ë¡œ íƒì§€ |
|----------------|----------------|----------------|
| 24ê°œ           | 4ê°œ            | 20ê°œ           |

\* CVE ì„¤ëª…ì— ë‚˜ì˜¨ ê¸°ì¤€ í•¨ìˆ˜(`Caller`: `produce_output`, `criterion`: `dprintf`)ëŠ” `dprintf`ê°€ `l_funcs`ì— ì¡´ì¬í•˜ì§€ ì•Šê¸° ë•Œë¬¸ì— ìŠ¬ë¼ì´ìŠ¤ ëª©ë¡ì— ì¡´ì¬í•˜ì§€ ì•ŠìŒ

produce_output()ì—ì„œ ì¶”ì¶œí•œ ìŠ¬ë¼ì´ìŠ¤ ì¤‘, Sink(`fprintf()` í•¨ìˆ˜) ê´€ë ¨ ìŠ¬ë¼ì´ìŠ¤ ì´ 4ê°œì¤‘ 2ê°œ ë§Œì´ ì·¨ì•½í•˜ì˜€ìœ¼ë‚˜, 4ê°œ ëª¨ë‘ **ì·¨ì•½ìœ¼ë¡œ íƒì§€ë¨**


| FileName  | Caller      | Source | Sink  | idx | CWE-ID | category       | criterion | line | label | token\_length | predict |
| --------- | ----------- | ------ | ----- | --- | ------ | -------------- | --------- | ---- | ----- | ------------- | ------- |
| preen_before.cpp | produce_output | FALSE | FALSE | 2 | CWE- | CallExpression | fprintf | 227 | -3 | 145 | 1 |
| preen_before.cpp | produce_output | FALSE | FALSE | 3 | CWE- | CallExpression | fprintf | 228 | -3 | 208 | 1 |
| preen_before.cpp | produce_output | FALSE | FALSE | 4 | CWE- | CallExpression | fprintf | 234 | -3 | 208 | 1 |
| preen_before.cpp | produce_output | FALSE | FALSE | 5 | CWE- | CallExpression | fprintf | 250 | -3 | 145 | 1 |


#### SARDëŠ” ì˜ íƒì§€í•˜ëŠ”ë° ì´ CVEëŠ” íƒì§€ ëª»í–ˆë˜ ì´ìœ 

1. **dprintf() -> criterion ë¦¬ìŠ¤íŠ¸ì— ìƒì„±ë˜ì§€ ì•ŠìŒ**
    - fprintf()ëŠ” l_funcs ë¦¬ìŠ¤íŠ¸ì— ì¡´ì¬í•˜ë‚˜, dprintf()ëŠ” ì¡´ì¬í•˜ì§€ ì•Šì•„ ìŠ¬ë¼ì´ìŠ¤ê°€ ìƒì„±ë˜ì§€ ì•ŠìŒ
    - criterionìœ¼ë¡œ dprintf()ì´ ì¡íˆì§€ ì•Šì•„ ì·¨ì•½ í˜¹ì€ ì •ìƒìœ¼ë¡œ íŒë‹¨ ë¶ˆê°€

2. **ì·¨ì•½í•˜ì§€ ì•Šì€ ë¼ì¸ì´ í¬í•¨ëœ ìŠ¬ë¼ì´ìŠ¤ê°€ ì˜¤íƒìœ¼ë¡œ ë¶„ë¥˜ë¨**

- ìŠ¬ë¼ì´ì‹± ë° í† í°í™” ê³¼ì •ì—ì„œ `fprintf(...)` í˜¸ì¶œì´ í¬í•¨ëœ ì „ì²´ ì½”ë“œ ë¸”ë¡ì´ í•˜ë‚˜ì˜ ìŠ¬ë¼ì´ìŠ¤ë¡œ ë¬¶ì„
- ì´ ì¤‘ ì¼ë¶€ëŠ” ì‹¤ì œë¡œ ì•ˆì „í•œ ì½”ë“œì„ì—ë„ ë¶ˆêµ¬í•˜ê³ , **ìŠ¬ë¼ì´ìŠ¤ì— ì·¨ì•½ì ì„ ë‚˜íƒ€ë‚´ëŠ” í† í°(`fprintf(Var2, Var4.FUNC1())`)ì´ í•¨ê»˜ í¬í•¨**ë˜ì–´ ìˆì—ˆê¸° ë•Œë¬¸ì—
- ëª¨ë¸ì€ í•´ë‹¹ ìŠ¬ë¼ì´ìŠ¤ ì „ì²´ë¥¼ **ì·¨ì•½(label=1)** ë¡œ ì˜ëª» íŒë‹¨í•œ ê²ƒìœ¼ë¡œ ì˜ˆìƒë¨

> **ì·¨ì•½í•˜ì§€ ì•Šì€ ì½”ë“œ(ì •ìƒ)**

```c
fprintf(mailer, "\n");  // âœ… í¬ë§· ë¬¸ìì—´ ëª…ì‹œ
```

> **ì •ìƒ ì½”ë“œì— ëŒ€í•´ ìŠ¬ë¼ì´ì„œê°€ ìƒì„±í•œ ì‹¤ì œ ìŠ¬ë¼ì´ìŠ¤ ä¸­ ì¼ë¶€**

```
"\t\tfprintf( mailer, \"\\n\" );\n",
"\t\tfprintf( mailer, szTmp.Value());\n",
```

> **ì •ìƒ ì½”ë“œì— ëŒ€í•´ í† í¬ë‚˜ì´ì €ê°€ ìƒì„±í•œ ì‹¤ì œ í† í° ä¸­ ì¼ë¶€**
```
fprintf(Var2,STRING); \n
fprintf(Var2,Var4.FUNC1()); // âš  í¬ë§· ë¯¸ì§€ì •
```

- ìœ„ì²˜ëŸ¼ ìŠ¬ë¼ì´ìŠ¤ì— **í¬ë§· ë¬¸ìì—´ì´ ëª…ì‹œëœ ì•ˆì „í•œ `fprintf()` í˜¸ì¶œ**ê³¼
  **í¬ë§· ë¬¸ìì—´ ì—†ì´ í˜¸ì¶œëœ ìœ„í—˜í•œ `fprintf()` í˜¸ì¶œ**ì´ í•¨ê»˜ í¬í•¨ë¨
- ì´ë¡œ ì¸í•´ ëª¨ë¸ì€ ìŠ¬ë¼ì´ìŠ¤ ì „ì²´ë¥¼ ìœ„í—˜í•˜ê²Œ íŒë‹¨ â†’ **False Positive ë°œìƒ**



## ì·¨ì•½ì  ì„¸ë¶€ ì‚¬í•­


---

### â—ï¸ ì·¨ì•½ ì½”ë“œ


#### Sink: `preen_before.cpp:224, 228, 333, 234`
```c
	szTmp.sprintf("The condor_preen process has found the following stale condor files on <%s>:\n\n",  get_local_hostname().Value());
	dprintf(D_ALWAYS, szTmp.Value());   // âš  ì·¨ì•½!
	if( MailFlag ) {
		fprintf( mailer, "\n" );   
		fprintf( mailer, szTmp.Value());   // âš  ì·¨ì•½!
	}

	for( BadFiles->rewind(); (str = BadFiles->next()); ) {
		szTmp.sprintf("  %s\n", str);
		dprintf(D_ALWAYS, szTmp.Value() );  // âš  ì·¨ì•½!
		fprintf( mailer, szTmp.Value() );   // âš  ì·¨ì•½!     
	}
```

---
### âœ… ê°œì„  ì½”ë“œ

#### 1. í¬ë§· ë¬¸ìì—´ ëª…ì‹œ

**íŒ¨ì¹˜ ìœ„ì¹˜**: `preen_before.cpp:224, 228, 233, 234`

```c
szTmp.sprintf("The condor_preen process has found the following stale condor files on <%s>:\n\n",  get_local_hostname().Value());
dprintf(D_ALWAYS, "%s", szTmp.Value());   // âœ… í¬ë§· ë¬¸ìì—´ ëª…ì‹œ

if (MailFlag) {
    fprintf(mailer, "\n");
    fprintf(mailer, "%s", szTmp.Value());  // âœ… í¬ë§· ë¬¸ìì—´ ëª…ì‹œ
}

for (BadFiles->rewind(); (str = BadFiles->next()); ) {
    szTmp.sprintf("  %s\n", str);
    dprintf(D_ALWAYS, "%s", szTmp.Value());   // âœ… í¬ë§· ë¬¸ìì—´ ëª…ì‹œ
    fprintf(mailer, "%s", szTmp.Value());     // âœ… í¬ë§· ë¬¸ìì—´ ëª…ì‹œ
}
```

**ê°œì„  ë°©ë²•**:

- ì™¸ë¶€ ì…ë ¥ ë˜ëŠ” ë™ì ìœ¼ë¡œ êµ¬ì„±ëœ ë¬¸ìì—´ì„ `dprintf()`ë‚˜ `fprintf()`ì— ì‚¬ìš©í•  ê²½ìš° ë°˜ë“œì‹œ í¬ë§· ë¬¸ìì—´(`"%s"`)ì„ ëª…ì‹œí•´ì•¼ í•©ë‹ˆë‹¤.
- í¬ë§· ë¬¸ìì—´ì„ ëª…ì‹œí•˜ì§€ ì•Šìœ¼ë©´ `%x`, `%n` ë“±ì˜ í¬ë§· ìŠ¤íŠ¸ë§ ê³µê²©ì— ì˜í•´ ë©”ëª¨ë¦¬ ëˆ„ì¶œ ë˜ëŠ” ì½”ë“œ ì‹¤í–‰ì´ ìœ ë°œë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

---
## íƒì§€ ê²°ê³¼

| FileName         | Caller                    | Source | Sink  | idx | CWE-ID | category       | criterion | line | label | token_length | predict |
|------------------|---------------------------|--------|-------|-----|--------|----------------|-----------|------|-------|--------------|---------|
| preen_before.cpp | usage                     | FALSE  | FALSE | 0   | CWE-   | CallExpression | fprintf   | 104  | -3    | 11           | 0       |
| preen_before.cpp | main                      | FALSE  | FALSE | 1   | CWE-   | CallExpression | free      | 168  | -3    | 56           | 0       |
| preen_before.cpp | produce_output            | FALSE  | FALSE | 2   | CWE-   | CallExpression | fprintf   | 227  | -3    | 145          | 1       |
| preen_before.cpp | produce_output            | FALSE  | FALSE | 3   | CWE-   | CallExpression | fprintf   | 228  | -3    | 208          | 1       |
| preen_before.cpp | produce_output            | FALSE  | FALSE | 4   | CWE-   | CallExpression | fprintf   | 234  | -3    | 208          | 1       |
| preen_before.cpp | produce_output            | FALSE  | FALSE | 5   | CWE-   | CallExpression | fprintf   | 250  | -3    | 145          | 1       |
| preen_before.cpp | check_job_spool_hierarchy | FALSE  | FALSE | 6   | CWE-   | CallExpression | sprintf   | 272  | -3    | 254          | 0       |
| preen_before.cpp | check_spool_dir           | FALSE  | FALSE | 7   | CWE-   | CallExpression | strlen    | 335  | -3    | 188          | 0       |
| preen_before.cpp | check_spool_dir           | FALSE  | FALSE | 8   | CWE-   | CallExpression | strlen    | 339  | -3    | 209          | 0       |
| preen_before.cpp | check_spool_dir           | FALSE  | FALSE | 9   | CWE-   | CallExpression | strlen    | 384  | -3    | 470          | 0       |
| preen_before.cpp | check_spool_dir           | FALSE  | FALSE | 10  | CWE-   | CallExpression | strlen    | 391  | -3    | 457          | 0       |
| preen_before.cpp | is_valid_shared_exe       | FALSE  | FALSE | 11  | CWE-   | CallExpression | strlen    | 456  | -3    | 120          | 0       |
| preen_before.cpp | is_ckpt_file              | FALSE  | FALSE | 12  | CWE-   | CallExpression | strstr    | 481  | -3    | 46           | 0       |
| preen_before.cpp | grab_val                  | FALSE  | FALSE | 13  | CWE-   | CallExpression | strstr    | 501  | -3    | 63           | 0       |
| preen_before.cpp | grab_val                  | FALSE  | FALSE | 14  | CWE-   | CallExpression | atoi      | 502  | -3    | 63           | 0       |
| preen_before.cpp | grab_val                  | FALSE  | FALSE | 15  | CWE-   | CallExpression | strlen    | 502  | -3    | 63           | 0       |
| preen_before.cpp | is_myproxy_file           | FALSE  | FALSE | 16  | CWE-   | CallExpression | sscanf    | 573  | -3    | 33           | 0       |
| preen_before.cpp | is_ccb_file               | FALSE  | FALSE | 17  | CWE-   | CallExpression | strstr    | 587  | -3    | 11           | 0       |
| preen_before.cpp | rec_lock_cleanup          | FALSE  | FALSE | 18  | CWE-   | CallExpression | unlink    | 743  | -3    | 213          | 0       |
| preen_before.cpp | rec_lock_cleanup          | FALSE  | FALSE | 19  | CWE-   | CallExpression | strerror  | 745  | -3    | 328          | 0       |
| preen_before.cpp | init_params               | FALSE  | FALSE | 20  | CWE-   | CallExpression | free      | 811  | -3    | 38           | 0       |
| preen_before.cpp | init_params               | FALSE  | FALSE | 21  | CWE-   | CallExpression | free      | 828  | -3    | 196          | 0       |
| preen_before.cpp | get_machine_state         | FALSE  | FALSE | 22  | CWE-   | CallExpression | free      | 932  | -3    | 115          | 0       |
| preen_before.cpp | get_machine_state         | FALSE  | FALSE | 23  | CWE-   | CallExpression | free      | 940  | -3    | 115          | 0       |
